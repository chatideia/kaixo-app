<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaixo Translate Pro v3.0 - Chat Multimedia + Documentos Avanzados</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    
    <!-- NUEVAS LIBRER√çAS PARA DOCUMENTOS AVANZADOS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.5.1/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.snow.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #e5ddd5;
            padding: 20px;
        }

        .chat-container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            height: 650px;
            display: flex;
            flex-direction: column;
        }

        /* Encabezado mejorado */
        .header {
            background: linear-gradient(135deg, #075e54, #128c7e);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .header p {
            margin: 5px 0 0 0;
            font-size: 12px;
            opacity: 0.9;
        }

        .connection-status {
            position: absolute;
            top: 10px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse-online 2s infinite;
        }

        .connection-status.offline {
            background: #ff5722;
        }

        @keyframes pulse-online {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Panel de usuario mejorado */
        .user-switcher {
            background: #f0f2f5;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .language-selector {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .language-selector:hover {
            border-color: #25d366;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
        }

        .switch-btn {
            background: #25d366;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .switch-btn:hover {
            background: #128c7e;
            transform: scale(1.05);
        }

        /* Mensajes mejorados */
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #e5ddd5;
        }

        .welcome {
            text-align: center;
            color: #333;
            background: white;
            padding: 30px 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .welcome h3 {
            margin: 0 0 15px 0;
            color: #075e54;
        }

        .language-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 15px;
        }

        .lang-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Chat bubbles mejoradas */
        .message {
            margin-bottom: 15px;
            display: flex;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            color: #333;
            transition: transform 0.2s;
        }

        .message-bubble:hover {
            transform: scale(1.02);
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, #dcf8c6, #c5f5b4);
            border-bottom-right-radius: 5px;
        }

        .message.received .message-bubble {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-bottom-left-radius: 5px;
        }

        /* Mensajes con imagen */
        .message-image {
            width: 100%;
            max-width: 200px;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-image:hover {
            transform: scale(1.05);
        }

        .image-loading {
            width: 200px;
            height: 150px;
            background: #f0f2f5;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 12px;
        }

        /* Video messages */
        .message-video {
            width: 100%;
            max-width: 250px;
            border-radius: 12px;
            margin-bottom: 8px;
            position: relative;
            background: #000;
        }

        .video-player {
            width: 100%;
            height: 180px;
            border-radius: 12px;
            object-fit: cover;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .video-overlay:hover {
            background: rgba(0,0,0,0.5);
        }

        .video-play-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: none;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .video-play-btn:hover {
            transform: scale(1.1);
        }

        .video-duration {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        /* Document messages MEJORADOS */
        .file-message {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(0,0,0,0.05);
            border-radius: 12px;
            margin-bottom: 8px;
            min-width: 200px;
            transition: background 0.2s;
            cursor: pointer;
        }

        .file-message:hover {
            background: rgba(0,0,0,0.08);
        }

        .file-icon {
            font-size: 32px;
            margin-right: 12px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .file-icon.pdf {
            background: #ff5722;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .file-icon.doc {
            background: #2196f3;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .file-icon.xls {
            background: #4caf50;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .file-icon.ppt {
            background: #ff9800;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .file-size {
            font-size: 12px;
            color: #666;
        }

        .file-actions {
            display: flex;
            gap: 8px;
            margin-left: 8px;
        }

        .file-action-btn {
            background: #25d366;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .file-action-btn:hover {
            background: #128c7e;
            transform: scale(1.1);
        }

        .file-action-btn.download {
            background: #17a2b8;
        }

        .file-action-btn.preview {
            background: #ffc107;
            color: #333;
        }

        .file-action-btn.edit {
            background: #fd7e14;
        }

        /* =====  MODAL DE DOCUMENTOS MEJORADO ===== */
        .document-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 10px;
        }

        .document-modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .document-content {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 900px;
            height: 85vh;
            max-height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Header con pesta√±as */
        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
        }

        .document-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            flex: 1;
            margin-right: 15px;
        }

        .document-tabs {
            display: flex;
            gap: 8px;
            margin-right: 15px;
        }

        .doc-tab {
            padding: 8px 16px;
            border: none;
            background: #e9ecef;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .doc-tab.active {
            background: #25d366;
            color: white;
        }

        .doc-tab:hover:not(.active) {
            background: #dee2e6;
        }

        .document-close {
            background: #ff4757;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Contenido del documento */
        .document-body {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .doc-content {
            display: none;
            height: 100%;
            overflow: auto;
            padding: 20px;
        }

        .doc-content.active {
            display: block;
        }

        /* ===== ESTILOS ESPEC√çFICOS PARA CADA TIPO ===== */

        /* PDF Viewer */
        .pdf-viewer {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .pdf-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
        }

        .pdf-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .pdf-btn:hover {
            background: #0056b3;
        }

        .pdf-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .pdf-page-info {
            font-size: 14px;
            font-weight: 500;
        }

        .pdf-canvas-container {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            background: #f8f9fa;
        }

        .pdf-canvas {
            max-width: 100%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        /* Excel Viewer/Editor */
        .excel-container {
            height: 100%;
            overflow: auto;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .excel-table th,
        .excel-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            min-width: 80px;
        }

        .excel-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .excel-table input {
            border: none;
            background: transparent;
            width: 100%;
            padding: 4px;
            font-size: 12px;
        }

        .excel-table input:focus {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 3px;
        }

        /* Word Editor */
        .word-editor {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .word-toolbar {
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .word-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .word-btn:hover {
            background: #e9ecef;
        }

        .word-btn.active {
            background: #007bff;
            color: white;
        }

        .quill-editor {
            flex: 1;
        }

        /* Loading states */
        .doc-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }

        .doc-loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #25d366;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Footer con acciones */
        .document-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .doc-info {
            font-size: 12px;
            color: #666;
        }

        .doc-actions {
            display: flex;
            gap: 10px;
        }

        .doc-action-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .doc-action-btn:hover {
            background: #0056b3;
        }

        .doc-action-btn.success {
            background: #28a745;
        }

        .doc-action-btn.success:hover {
            background: #1e7e34;
        }

        .doc-action-btn.danger {
            background: #dc3545;
        }

        .doc-action-btn.danger:hover {
            background: #c82333;
        }

        /* Emoji Picker */
        .emoji-picker {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 16px;
            display: none;
            z-index: 100;
            width: 320px;
            max-height: 400px;
        }

        .emoji-picker.active {
            display: block;
            animation: slideUp 0.2s ease;
        }

        .emoji-categories {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 8px;
        }

        .emoji-category {
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.2s;
        }

        .emoji-category:hover,
        .emoji-category.active {
            background: #f0f2f5;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            max-height: 280px;
            overflow-y: auto;
        }

        .emoji-item {
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 20px;
            transition: background 0.2s;
        }

        .emoji-item:hover {
            background: #f0f2f5;
            transform: scale(1.2);
        }

        .emoji-search {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-bottom: 12px;
            font-size: 14px;
            outline: none;
        }

        /* GIF Picker */
        .gif-picker {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 16px;
            display: none;
            z-index: 100;
            width: 320px;
            max-height: 400px;
        }

        .gif-picker.active {
            display: block;
            animation: slideUp 0.2s ease;
        }

        .gif-search {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-bottom: 12px;
            font-size: 14px;
            outline: none;
        }

        .gif-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            max-height: 320px;
            overflow-y: auto;
        }

        .gif-item {
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .gif-item:hover {
            transform: scale(1.05);
        }

        .gif-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        /* Message reactions */
        .message-reactions {
            margin-top: 8px;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .reaction {
            background: rgba(37, 211, 102, 0.1);
            border: 1px solid rgba(37, 211, 102, 0.3);
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reaction:hover {
            background: rgba(37, 211, 102, 0.2);
            transform: scale(1.1);
        }

        .reaction-btn {
            background: transparent;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .reaction-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        /* Emoji grande mejorado */
        .emoji-large {
            font-size: 64px !important;
            text-align: center;
            padding: 20px 10px;
            line-height: 1;
            animation: emojiPop 0.3s ease;
        }

        @keyframes emojiPop {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Mensaje multimedia sin controles */
        .multimedia-only {
            border: none !important;
        }

        .multimedia-only .translation-info {
            display: none !important;
        }

        /* Reaction picker temporal */
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* Sticker message */
        .sticker-message {
            text-align: center;
            padding: 10px;
        }

        .sticker-message img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            animation: stickerSlide 0.4s ease;
        }

        @keyframes stickerSlide {
            from { transform: scale(0.5) rotate(-5deg); opacity: 0; }
            to { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .message-text {
            margin-bottom: 5px;
            line-height: 1.4;
            font-size: 14px;
        }

        .translation-info {
            font-size: 11px;
            color: #667781;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .message-time {
            font-size: 11px;
            color: #667781;
            text-align: right;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
        }

        .delivery-status {
            font-size: 10px;
        }

        /* ===== NUEVO MEN√ö MULTIMEDIA UNIFICADO ===== */
        .input-area {
            background: white;
            padding: 15px 20px;
            display: flex;
            gap: 12px;
            align-items: flex-end;
            border-top: 1px solid #e5e7eb;
            position: relative;
        }

        /* Contenedor principal del bot√≥n + */
        .multimedia-container {
            position: relative;
        }

        /* Bot√≥n principal + */
        .main-plus-btn {
            background: linear-gradient(135deg, #25d366, #128c7e);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(37, 211, 102, 0.3);
        }

        .main-plus-btn:hover {
            transform: scale(1.1) rotate(45deg);
            box-shadow: 0 4px 20px rgba(37, 211, 102, 0.5);
        }

        .main-plus-btn.active {
            transform: scale(1.1) rotate(45deg);
            background: linear-gradient(135deg, #ff4757, #ff3838);
        }

        /* Men√∫ desplegable principal */
        .multimedia-menu {
            position: absolute;
            bottom: 55px;
            left: 0;
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            padding: 16px;
            display: none;
            z-index: 100;
            min-width: 280px;
            transform: translateY(10px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .multimedia-menu.active {
            display: block;
            transform: translateY(0);
            opacity: 1;
            animation: menuSlideUp 0.3s ease;
        }

        @keyframes menuSlideUp {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        /* T√≠tulo del men√∫ */
        .menu-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
        }

        /* Grid de opciones */
        .menu-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        /* Cada opci√≥n del men√∫ */
        .menu-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #f8f9fa;
            border: 2px solid transparent;
        }

        .menu-option:hover {
            background: #e9ecef;
            transform: translateY(-2px);
            border-color: #25d366;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.2);
        }

        .menu-option .icon {
            font-size: 32px;
            margin-bottom: 8px;
            transition: transform 0.2s ease;
        }

        .menu-option:hover .icon {
            transform: scale(1.2);
        }

        .menu-option .label {
            font-size: 12px;
            font-weight: 500;
            color: #333;
            text-align: center;
        }

        /* Colores espec√≠ficos para cada opci√≥n */
        .menu-option.emoji {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        }

        .menu-option.emoji:hover {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
        }

        .menu-option.gif {
            background: linear-gradient(135deg, #f8d7da, #fab1a0);
        }

        .menu-option.gif:hover {
            background: linear-gradient(135deg, #fab1a0, #e17055);
        }

        .menu-option.sticker {
            background: linear-gradient(135deg, #e2e3f0, #a29bfe);
        }

        .menu-option.sticker:hover {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
        }

        .menu-option.document {
            background: linear-gradient(135deg, #d1ecf1, #74b9ff);
        }

        .menu-option.document:hover {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
        }

        .menu-option.gallery {
            background: linear-gradient(135deg, #d4edda, #00b894);
        }

        .menu-option.gallery:hover {
            background: linear-gradient(135deg, #00b894, #00a085);
        }

        .menu-option.camera {
            background: linear-gradient(135deg, #fff4e6, #fd79a8);
        }

        .menu-option.camera:hover {
            background: linear-gradient(135deg, #fd79a8, #e84393);
        }

        /* Bot√≥n de voz separado */
        .voice-btn {
            background: #ff4757;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-btn:hover {
            background: #ff3838;
            transform: scale(1.1);
        }

        .voice-btn.recording {
            background: #ff0000;
            animation: pulse-record 1s infinite;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }

        @keyframes pulse-record {
            0% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            }
        }

        /* Campo de texto */
        #message-input {
            flex: 1;
            border: 1px solid #d1d5db;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 14px;
            outline: none;
            color: #333;
            resize: none;
            max-height: 100px;
            min-height: 45px;
        }

        #message-input:focus {
            border-color: #25d366;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
        }

        /* Bot√≥n de enviar */
        .send-btn {
            background: #25d366;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: #128c7e;
            transform: scale(1.1);
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Estado de traducci√≥n */
        .status {
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 20px;
            text-align: center;
            font-size: 12px;
            display: none;
        }

        .status.active {
            display: block;
        }

        .status.firebase {
            background: #fff3e0;
            color: #f57c00;
        }

        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
        }

        .translating {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Estado de voz (mantener original) */
        .voice-status {
            background: #f8f9fa;
            color: #495057;
            padding: 8px 20px;
            text-align: center;
            font-size: 12px;
            border-top: 1px solid #e5e7eb;
            display: none;
        }

        .voice-status.active {
            display: block;
        }

        .voice-status.recording {
            background: #ffe6e6;
            color: #dc2626;
            animation: pulse-text 1.5s infinite;
        }

        .voice-status.processing {
            background: #fff4e6;
            color: #d97706;
        }

        @keyframes pulse-text {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Controles de audio (mantener original) */
        .audio-controls {
            background: #f8f9fa;
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            border-top: 1px solid #e5e7eb;
            flex-wrap: wrap;
        }

        .control-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #495057;
            transform: scale(1.05);
        }

        .control-btn.active {
            background: #28a745;
        }

        .play-btn {
            background: #17a2b8;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            margin-left: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .play-btn:hover {
            background: #138496;
            transform: scale(1.1);
        }

        .play-btn.playing {
            background: #dc3545;
            animation: pulse-play 1s infinite;
        }

        @keyframes pulse-play {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Login modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 350px;
            text-align: center;
        }

        .login-content h3 {
            margin-bottom: 20px;
            color: #075e54;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-btn.primary {
            background: #25d366;
            color: white;
        }

        .login-btn.primary:hover {
            background: #128c7e;
        }

        .login-btn.secondary {
            background: #f0f2f5;
            color: #333;
        }

        .login-btn.secondary:hover {
            background: #e4e6ea;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Hidden file input */
        .hidden {
            display: none;
        }

        /* User status */
        #current-user {
            color: #333;
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 480px) {
            body {
                padding: 0;
            }
            
            .chat-container {
                height: 100vh;
                border-radius: 0;
                max-width: 100%;
            }

            .multimedia-menu {
                min-width: 260px;
            }

            .menu-options {
                grid-template-columns: repeat(2, 1fr);
            }

            .document-content {
                width: 98%;
                height: 90vh;
            }

            .pdf-controls {
                flex-wrap: wrap;
                gap: 8px;
            }

            .pdf-btn {
                padding: 6px 8px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <div class="connection-status" id="connectionStatus"></div>
            <h2>üåç Kaixo Translate Pro v3.0</h2>
            <p>Chat Universal + Documentos Avanzados + IA</p>
        </div>
        
        <div class="user-switcher">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar" onclick="showUserProfile()">U1</div>
                <div>
                    <span id="current-user">üë§ Usuario 1</span>
                    <select id="language-select" class="language-selector" onchange="changeUserLanguage()">
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="en">üá¨üáß English</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                        <option value="de">üá©üá™ Deutsch</option>
                        <option value="it">üáÆüáπ Italiano</option>
                        <option value="pt">üáµüáπ Portugu√™s</option>
                        <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                        <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                        <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                        <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                        <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                        <option value="hi">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                    </select>
                </div>
            </div>
            <button onclick="switchUser()" class="switch-btn">Cambiar Usuario</button>
        </div>
        
        <div class="messages" id="messages">
            <div class="welcome">
                <h3>¬°Kaixo Translate Pro v3.0! üåü</h3>
                <p>Chat universal con IA + Vista previa y edici√≥n de PDF, Excel y Word</p>
                <div class="language-list">
                    <span class="lang-badge">üá™üá∏ Espa√±ol</span>
                    <span class="lang-badge">üá¨üáß English</span>
                    <span class="lang-badge">üá´üá∑ Fran√ßais</span>
                    <span class="lang-badge">üá©üá™ Deutsch</span>
                    <span class="lang-badge">üáÆüáπ Italiano</span>
                    <span class="lang-badge">üáµüáπ Portugu√™s</span>
                    <span class="lang-badge">üá∑üá∫ –†—É—Å—Å–∫–∏–π</span>
                    <span class="lang-badge">üáØüáµ Êó•Êú¨Ë™û</span>
                    <span class="lang-badge">üá∞üá∑ ÌïúÍµ≠Ïñ¥</span>
                    <span class="lang-badge">üá®üá≥ ‰∏≠Êñá</span>
                    <span class="lang-badge">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</span>
                    <span class="lang-badge">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</span>
                </div>
                <div style="margin-top: 15px; font-size: 12px; color: #666;">
                    <p>üìÑ <strong>Nuevo:</strong> Vista previa de PDFs con navegaci√≥n</p>
                    <p>üìä <strong>Nuevo:</strong> Editor completo de Excel</p>
                    <p>üìù <strong>Nuevo:</strong> Editor de Word con formato</p>
                </div>
            </div>
        </div>
        
        <!-- NUEVA √ÅREA DE INPUT UNIFICADA -->
        <div class="input-area">
            <!-- Bot√≥n multimedia principal + -->
            <div class="multimedia-container">
                <button class="main-plus-btn" id="mainPlusBtn" onclick="toggleMultimediaMenu()">+</button>
                
                <!-- Men√∫ desplegable -->
                <div class="multimedia-menu" id="multimediaMenu">
                    <div class="menu-title">üé≠ Multimedia & Documentos</div>
                    <div class="menu-options">
                        <div class="menu-option emoji" onclick="selectMenuOption('emoji')">
                            <div class="icon">üòÄ</div>
                            <div class="label">Emojis</div>
                        </div>
                        
                        <div class="menu-option gif" onclick="selectMenuOption('gif')">
                            <div class="icon">üé¨</div>
                            <div class="label">GIFs</div>
                        </div>
                        
                        <div class="menu-option sticker" onclick="selectMenuOption('sticker')">
                            <div class="icon">üé™</div>
                            <div class="label">Stickers</div>
                        </div>
                        
                        <div class="menu-option document" onclick="selectMenuOption('document')">
                            <div class="icon">üìÑ</div>
                            <div class="label">Documentos</div>
                        </div>
                        
                        <div class="menu-option gallery" onclick="selectMenuOption('gallery')">
                            <div class="icon">üñºÔ∏è</div>
                            <div class="label">Galer√≠a</div>
                        </div>
                        
                        <div class="menu-option camera" onclick="selectMenuOption('camera')">
                            <div class="icon">üì∏</div>
                            <div class="label">C√°mara</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bot√≥n de voz -->
            <button id="voice-btn" class="voice-btn" 
                    onmousedown="startRecording()" 
                    onmouseup="stopRecording()"
                    ontouchstart="startRecording()" 
                    ontouchend="stopRecording()">
                üé§
            </button>
            
            <!-- Campo de texto -->
            <textarea id="message-input" 
                   placeholder="Escribe en cualquier idioma..." 
                   rows="1"
                   onkeypress="handleEnterKey(event)"
                   oninput="autoResize()"></textarea>
            
            <!-- Bot√≥n enviar -->
            <button onclick="sendMessage()" class="send-btn" id="sendBtn">‚û§</button>
        </div>
        
        <div id="status" class="status"></div>
    </div>
    
    <div id="voice-status" class="voice-status">
        <span id="voice-text">Mant√©n presionado üé§ para hablar</span>
    </div>
    
    <div id="audio-controls" class="audio-controls">
        <button onclick="toggleAutoPlay()" id="autoplay-btn" class="control-btn active">
            üîä Auto-reproducir: ON
        </button>
        <button onclick="changeVoiceSpeed()" id="speed-btn" class="control-btn">
            ‚ö° Velocidad: Normal
        </button>
        <button onclick="showAvailableVoices()" class="control-btn">
            üéôÔ∏è Ver Voces
        </button>
        <button onclick="toggleFirebase()" id="firebase-btn" class="control-btn">
            üî• Firebase: OFF
        </button>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="login-modal" style="display: none;">
        <div class="login-content">
            <h3>üî• Conectar a Firebase</h3>
            <p style="margin-bottom: 20px; font-size: 14px; color: #666;">
                Ingresa tu nombre de usuario para el chat en tiempo real
            </p>
            <input type="text" id="usernameInput" class="login-input" placeholder="Tu nombre de usuario" maxlength="20">
            <button onclick="connectFirebase()" class="login-btn primary">üöÄ Conectar</button>
            <button onclick="closeLogin()" class="login-btn secondary">‚ùå Cancelar</button>
        </div>
    </div>

    <!-- Emoji Picker -->
    <div id="emojiPicker" class="emoji-picker">
        <input type="text" class="emoji-search" placeholder="Buscar emojis..." onkeyup="searchEmojis(event)">
        <div class="emoji-categories">
            <span class="emoji-category active" data-category="smileys" onclick="selectEmojiCategory('smileys')">üòÄ</span>
            <span class="emoji-category" data-category="animals" onclick="selectEmojiCategory('animals')">üê∂</span>
            <span class="emoji-category" data-category="food" onclick="selectEmojiCategory('food')">üçé</span>
            <span class="emoji-category" data-category="travel" onclick="selectEmojiCategory('travel')">‚úàÔ∏è</span>
            <span class="emoji-category" data-category="activities" onclick="selectEmojiCategory('activities')">‚öΩ</span>
            <span class="emoji-category" data-category="objects" onclick="selectEmojiCategory('objects')">üí°</span>
            <span class="emoji-category" data-category="symbols" onclick="selectEmojiCategory('symbols')">‚ù§Ô∏è</span>
        </div>
        <div class="emoji-grid" id="emojiGrid">
            <!-- Los emojis se cargar√°n din√°micamente -->
        </div>
    </div>

    <!-- GIF Picker -->
    <div id="gifPicker" class="gif-picker">
        <input type="text" class="gif-search" placeholder="Buscar GIFs..." onkeyup="searchGifs(event)">
        <div class="gif-grid" id="gifGrid">
            <!-- Los GIFs se cargar√°n din√°micamente -->
        </div>
    </div>

    <!-- ===== MODAL DE DOCUMENTOS MEJORADO ===== -->
    <div id="documentModal" class="document-modal">
        <div class="document-content">
            <!-- Header con pesta√±as -->
            <div class="document-header">
                <div class="document-title" id="documentTitle">Documento</div>
                <div class="document-tabs" id="documentTabs">
                    <button class="doc-tab active" data-tab="preview" onclick="switchDocTab('preview')">üëÅÔ∏è Vista</button>
                    <button class="doc-tab" data-tab="edit" onclick="switchDocTab('edit')">‚úèÔ∏è Editar</button>
                    <button class="doc-tab" data-tab="info" onclick="switchDocTab('info')">‚ÑπÔ∏è Info</button>
                </div>
                <button class="document-close" onclick="closeDocumentModal()">‚úï</button>
            </div>
            
            <!-- Contenido del documento -->
            <div class="document-body">
                <!-- Vista previa -->
                <div id="docPreview" class="doc-content active">
                    <div class="doc-loading" id="docLoading">
                        <div class="doc-loading-spinner"></div>
                        <p>Cargando documento...</p>
                    </div>
                </div>
                
                <!-- Editor -->
                <div id="docEditor" class="doc-content">
                    <!-- El contenido se generar√° din√°micamente -->
                </div>
                
                <!-- Informaci√≥n -->
                <div id="docInfo" class="doc-content">
                    <div style="padding: 20px;">
                        <h4 style="margin-bottom: 15px;">üìã Informaci√≥n del Documento</h4>
                        <div id="docInfoContent">
                            <!-- Informaci√≥n se cargar√° aqu√≠ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer con acciones -->
            <div class="document-footer">
                <div class="doc-info" id="docFooterInfo">
                    Listo para usar
                </div>
                <div class="doc-actions">
                    <button onclick="downloadDocument()" class="doc-action-btn">üì• Descargar</button>
                    <button onclick="saveDocumentChanges()" class="doc-action-btn success" id="saveDocBtn" style="display: none;">üíæ Guardar</button>
                    <button onclick="shareDocument()" class="doc-action-btn">üîó Compartir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="imageInput" class="hidden" accept="image/*" multiple onchange="handleFileSelect(event, 'image')">
    <input type="file" id="videoInput" class="hidden" accept="video/*" onchange="handleFileSelect(event, 'video')">
    <input type="file" id="documentInput" class="hidden" accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx" onchange="handleFileSelect(event, 'document')">
    <input type="file" id="cameraInput" class="hidden" accept="image/*" capture="environment" onchange="handleFileSelect(event, 'camera')">

    <script>
        // === CONFIGURACI√ìN FIREBASE (DEMO) ===
        const firebaseConfig = {
            // Configuraci√≥n demo - reemplazar con tu config real
            apiKey: "demo-api-key",
            authDomain: "kaixo-translate-demo.firebaseapp.com", 
            databaseURL: "https://kaixo-translate-demo-default-rtdb.firebaseio.com",
            projectId: "kaixo-translate-demo",
            storageBucket: "kaixo-translate-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:demo123"
        };

        // Variables Firebase
        let firebaseApp = null;
        let database = null;
        let storage = null;
        let firebaseConnected = false;
        let chatRef = null;
        let currentUsername = null;

        // === CONFIGURACI√ìN MULTIIDIOMA ORIGINAL (MANTENER INTACTO) ===
        let currentUser = 'user1';
        let messages = [];

        const languages = {
            es: { name: 'Espa√±ol', flag: 'üá™üá∏', voice: 'es-ES', region: 'Espa√±a' },
            en: { name: 'English', flag: 'üá¨üáß', voice: 'en-US', region: 'USA' },
            fr: { name: 'Fran√ßais', flag: 'üá´üá∑', voice: 'fr-FR', region: 'France' },
            de: { name: 'Deutsch', flag: 'üá©üá™', voice: 'de-DE', region: 'Deutschland' },
            it: { name: 'Italiano', flag: 'üáÆüáπ', voice: 'it-IT', region: 'Italia' },
            pt: { name: 'Portugu√™s', flag: 'üáµüáπ', voice: 'pt-BR', region: 'Brasil' },
            ru: { name: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫', voice: 'ru-RU', region: '–†–æ—Å—Å–∏—è' },
            ja: { name: 'Êó•Êú¨Ë™û', flag: 'üáØüáµ', voice: 'ja-JP', region: 'Êó•Êú¨' },
            ko: { name: 'ÌïúÍµ≠Ïñ¥', flag: 'üá∞üá∑', voice: 'ko-KR', region: 'ÎåÄÌïúÎØºÍµ≠' },
            zh: { name: '‰∏≠Êñá', flag: 'üá®üá≥', voice: 'zh-CN', region: '‰∏≠ÂõΩ' },
            ar: { name: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', flag: 'üá∏üá¶', voice: 'ar-SA', region: 'ÿßŸÑÿ≥ÿπŸàÿØŸäÿ©' },
            hi: { name: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', flag: 'üáÆüá≥', voice: 'hi-IN', region: '‡§≠‡§æ‡§∞‡§§' }
        };

        const userInfo = {
            user1: { name: 'Usuario 1', lang: 'es' },
            user2: { name: 'Usuario 2', lang: 'en' }
        };

        // ===== NUEVAS VARIABLES PARA DOCUMENTOS =====
        let currentDocument = null;
        let currentDocumentType = null;
        let documentData = null;
        let isDocumentModified = false;
        let quillEditor = null;

        // ===== NUEVAS FUNCIONES PARA MEN√ö MULTIMEDIA UNIFICADO =====
        
        // Funci√≥n para alternar el men√∫ principal
        function toggleMultimediaMenu() {
            const menu = document.getElementById('multimediaMenu');
            const btn = document.getElementById('mainPlusBtn');
            
            // Cerrar otros pickers si est√°n abiertos
            closeAllPickers();
            
            menu.classList.toggle('active');
            btn.classList.toggle('active');
            
            if (menu.classList.contains('active')) {
                // Agregar event listener para cerrar al hacer click fuera
                setTimeout(() => {
                    document.addEventListener('click', closeMultimediaMenu);
                }, 100);
            }
        }

        // Funci√≥n para cerrar el men√∫ multimedia
        function closeMultimediaMenu(event) {
            const menu = document.getElementById('multimediaMenu');
            const btn = document.getElementById('mainPlusBtn');
            const container = event?.target.closest('.multimedia-container');
            
            if (!container) {
                menu.classList.remove('active');
                btn.classList.remove('active');
                document.removeEventListener('click', closeMultimediaMenu);
            }
        }

        // Funci√≥n para manejar la selecci√≥n de opciones del men√∫
        function selectMenuOption(option) {
            console.log(`üé≠ Opci√≥n seleccionada: ${option}`);
            
            // Cerrar el men√∫ multimedia
            const menu = document.getElementById('multimediaMenu');
            const btn = document.getElementById('mainPlusBtn');
            menu.classList.remove('active');
            btn.classList.remove('active');
            document.removeEventListener('click', closeMultimediaMenu);
            
            // Ejecutar acci√≥n seg√∫n la opci√≥n
            switch(option) {
                case 'emoji':
                    toggleEmojiPicker();
                    break;
                case 'gif':
                    toggleGifPicker();
                    break;
                case 'sticker':
                    showStickers();
                    break;
                case 'document':
                    selectDocuments();
                    break;
                case 'gallery':
                    selectImages();
                    break;
                case 'camera':
                    takePhoto();
                    break;
                default:
                    console.log('Opci√≥n no reconocida:', option);
            }
        }

        // Funci√≥n para cerrar todos los pickers
        function closeAllPickers() {
            document.getElementById('emojiPicker').classList.remove('active');
            document.getElementById('gifPicker').classList.remove('active');
        }

        // === FUNCIONES DE ARCHIVOS MEJORADAS ===
        
        function selectImages() {
            document.getElementById('imageInput').click();
            showStatus('üì∏ Selecciona im√°genes de tu galer√≠a', 'firebase');
        }

        function selectDocuments() {
            document.getElementById('documentInput').click();
            showStatus('üìÑ Selecciona documentos (PDF, DOC, XLS, etc.)', 'firebase');
        }

        function takePhoto() {
            document.getElementById('cameraInput').click();
            showStatus('üì∏ Abriendo c√°mara...', 'firebase');
        }

        function handleFileSelect(event, type) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            Array.from(files).forEach(file => {
                processFile(file, type);
            });
            
            // Limpiar input
            event.target.value = '';
        }

        function processFile(file, type) {
            // Validar tama√±o seg√∫n tipo
            const maxSizes = {
                image: 5 * 1024 * 1024,   // 5MB
                video: 50 * 1024 * 1024,  // 50MB
                document: 10 * 1024 * 1024, // 10MB
                camera: 5 * 1024 * 1024    // 5MB
            };

            if (file.size > maxSizes[type]) {
                const maxSizeMB = maxSizes[type] / (1024 * 1024);
                alert(`El archivo es demasiado grande. M√°ximo ${maxSizeMB}MB para ${type}.`);
                return;
            }

            showStatus(`üì§ Enviando ${type}...`, 'firebase');

            if (type === 'image' || type === 'camera') {
                handleImageFile(file);
            } else if (type === 'video') {
                handleVideoFile(file);
            } else if (type === 'document') {
                handleDocumentFile(file);
            }
        }

        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageMessage = {
                    id: Date.now(),
                    sender: currentUser,
                    senderLang: userInfo[currentUser].lang,
                    type: 'image',
                    imageData: e.target.result,
                    fileName: file.name,
                    fileSize: file.size,
                    text: '',
                    timestamp: new Date().toLocaleTimeString(),
                    isTranslating: false,
                    translation: null,
                    hasAudio: false
                };

                messages.push(imageMessage);
                renderMessages();
                scrollToBottom();
                
                showStatus('‚úÖ Imagen enviada', 'success');

                if (firebaseConnected) {
                    setTimeout(() => {
                        showStatus('üî• Imagen sincronizada', 'firebase');
                    }, 1000);
                }
            };
            reader.readAsDataURL(file);
        }

        function handleVideoFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const videoMessage = {
                    id: Date.now(),
                    sender: currentUser,
                    senderLang: userInfo[currentUser].lang,
                    type: 'video',
                    videoData: e.target.result,
                    fileName: file.name,
                    fileSize: file.size,
                    mimeType: file.type,
                    duration: null,
                    text: '',
                    timestamp: new Date().toLocaleTimeString(),
                    isTranslating: false,
                    translation: null,
                    hasAudio: false,
                    reactions: {}
                };

                messages.push(videoMessage);
                renderMessages();
                scrollToBottom();
                
                showStatus('‚úÖ Video enviado correctamente', 'success');

                if (firebaseConnected) {
                    setTimeout(() => {
                        showStatus('üî• Video sincronizado', 'firebase');
                    }, 1000);
                }
            };
            reader.readAsDataURL(file);
        }

        function handleDocumentFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const docMessage = {
                    id: Date.now(),
                    sender: currentUser,
                    senderLang: userInfo[currentUser].lang,
                    type: 'document',
                    documentData: e.target.result,
                    fileName: file.name,
                    fileSize: file.size,
                    mimeType: file.type,
                    text: '',
                    timestamp: new Date().toLocaleTimeString(),
                    isTranslating: false,
                    translation: null,
                    hasAudio: false,
                    reactions: {},
                    // NUEVAS propiedades para documentos avanzados
                    originalFile: file,
                    isProcessed: false,
                    documentContent: null
                };

                messages.push(docMessage);
                renderMessages();
                scrollToBottom();
                
                showStatus('‚úÖ Documento enviado con vista previa avanzada', 'success');

                if (firebaseConnected) {
                    setTimeout(() => {
                        showStatus('üî• Documento sincronizado', 'firebase');
                    }, 1000);
                }
            };
            reader.readAsDataURL(file);
        }

        // === FUNCIONES DE DOCUMENTOS MEJORADAS ===

        function getDocumentIcon(extension) {
            switch(extension.toLowerCase()) {
                case 'pdf': return 'PDF';
                case 'doc':
                case 'docx': return 'DOC';
                case 'xls':
                case 'xlsx': return 'XLS';
                case 'ppt':
                case 'pptx': return 'PPT';
                default: return 'FILE';
            }
        }

        function getDocumentIconEmoji(extension) {
            switch(extension.toLowerCase()) {
                case 'pdf': return 'üìÑ';
                case 'doc':
                case 'docx': return 'üìù';
                case 'xls':
                case 'xlsx': return 'üìä';
                case 'ppt':
                case 'pptx': return 'üìà';
                case 'txt': return 'üìÑ';
                case 'zip':
                case 'rar': return 'üóúÔ∏è';
                default: return 'üìã';
            }
        }

        function getDocumentIconClass(extension) {
            switch(extension.toLowerCase()) {
                case 'pdf': return 'pdf';
                case 'doc':
                case 'docx': return 'doc';
                case 'xls':
                case 'xlsx': return 'xls';
                case 'ppt':
                case 'pptx': return 'ppt';
                default: return 'pdf';
            }
        }

        // ===== FUNCI√ìN PRINCIPAL MEJORADA PARA ABRIR DOCUMENTOS =====
        async function previewDocument(messageId) {
            console.log('üîç Iniciando vista previa para documento ID:', messageId);
            
            const message = messages.find(m => m.id === messageId);
            if (!message) {
                showStatus('‚ùå Documento no encontrado', 'error');
                console.error('‚ùå Mensaje no encontrado:', messageId);
                return;
            }
            
            console.log('üìÑ Documento encontrado:', message.fileName);
            
            currentDocument = message;
            currentDocumentType = message.fileName.split('.').pop().toLowerCase();
            isDocumentModified = false;
            
            console.log('üîß Tipo de documento detectado:', currentDocumentType);
            
            // Abrir modal
            const modal = document.getElementById('documentModal');
            const title = document.getElementById('documentTitle');
            title.textContent = message.fileName;
            
            // Resetear tabs
            switchDocTab('preview');
            
            // Mostrar loading
            showDocumentLoading('Analizando documento...');
            
            modal.classList.add('active');
            
            try {
                // Verificar disponibilidad de librer√≠as
                console.log('üîç Verificando librer√≠as disponibles...');
                console.log('PDF.js disponible:', typeof pdfjsLib !== 'undefined');
                console.log('SheetJS disponible:', typeof XLSX !== 'undefined');
                console.log('Mammoth disponible:', typeof mammoth !== 'undefined');
                console.log('Quill disponible:', typeof Quill !== 'undefined');
                
                // Procesar documento seg√∫n tipo
                if (currentDocumentType === 'pdf') {
                    console.log('üìÑ Procesando PDF...');
                    await loadPDFDocument(message);
                } else if (['xls', 'xlsx'].includes(currentDocumentType)) {
                    console.log('üìä Procesando Excel...');
                    await loadExcelDocument(message);
                } else if (['doc', 'docx'].includes(currentDocumentType)) {
                    console.log('üìù Procesando Word...');
                    await loadWordDocument(message);
                } else {
                    console.log('üìÅ Procesando documento gen√©rico...');
                    await loadGenericDocument(message);
                }
                
                // Cargar informaci√≥n del documento
                loadDocumentInfo(message);
                
                showStatus('üëÅÔ∏è Vista previa cargada correctamente', 'success');
                console.log('‚úÖ Vista previa completada exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error completo cargando documento:', error);
                showStatus('‚ùå Error al cargar vista previa: ' + error.message, 'error');
                showDocumentError(`Error al procesar el documento: ${error.message}`);
            }
        }

        // ===== FUNCI√ìN PARA MOSTRAR LOADING =====
        function showDocumentLoading(message) {
            const preview = document.getElementById('docPreview');
            preview.innerHTML = `
                <div class="doc-loading">
                    <div class="doc-loading-spinner"></div>
                    <p>${message}</p>
                </div>
            `;
        }

        // ===== FUNCI√ìN PARA MOSTRAR ERROR =====
        function showDocumentError(message) {
            const preview = document.getElementById('docPreview');
            preview.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #dc3545;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                    <h3>Error al cargar documento</h3>
                    <p style="color: #666; text-align: center;">${message}</p>
                    <button onclick="previewDocument(${currentDocument.id})" class="doc-action-btn" style="margin-top: 15px;">
                        üîÑ Reintentar
                    </button>
                </div>
            `;
        }

        // ===== PROCESAMIENTO DE PDF CON PDF.js =====
        async function loadPDFDocument(message) {
            showDocumentLoading('Cargando PDF...');
            
            try {
                // Verificar que PDF.js est√© disponible
                if (typeof pdfjsLib === 'undefined') {
                    throw new Error('PDF.js no est√° disponible');
                }
                
                // Configurar PDF.js
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                // Cargar PDF desde data URL
                const pdf = await pdfjsLib.getDocument(message.documentData).promise;
                
                let currentPage = 1;
                const totalPages = pdf.numPages;
                
                // Crear interfaz PDF
                const preview = document.getElementById('docPreview');
                preview.innerHTML = `
                    <div class="pdf-viewer">
                        <div class="pdf-controls">
                            <button class="pdf-btn" onclick="pdfPrevPage()" id="pdfPrevBtn">‚¨ÖÔ∏è Anterior</button>
                            <span class="pdf-page-info">
                                <input type="number" id="pdfPageInput" value="1" min="1" max="${totalPages}" style="width: 50px; text-align: center; padding: 4px; border: 1px solid #ddd; border-radius: 4px;" onchange="pdfGoToPage()">
                                / ${totalPages}
                            </span>
                            <button class="pdf-btn" onclick="pdfNextPage()" id="pdfNextBtn">Siguiente ‚û°Ô∏è</button>
                            <button class="pdf-btn" onclick="pdfZoomOut()" id="pdfZoomOutBtn">üîç-</button>
                            <span id="pdfZoomLevel">100%</span>
                            <button class="pdf-btn" onclick="pdfZoomIn()" id="pdfZoomInBtn">üîç+</button>
                        </div>
                        <div class="pdf-canvas-container" id="pdfCanvasContainer">
                            <canvas id="pdfCanvas"></canvas>
                        </div>
                    </div>
                `;
                
                // Variables globales para PDF
                window.pdfDocument = pdf;
                window.pdfCurrentPage = 1;
                window.pdfZoom = 1.0;
                
                // Renderizar primera p√°gina
                await renderPDFPage(1);
                
                // Configurar editor para PDF (solo texto b√°sico)
                setupPDFEditor();
                
                showStatus('‚úÖ PDF cargado correctamente', 'success');
                
            } catch (error) {
                console.error('Error cargando PDF:', error);
                showDocumentError('Error al cargar PDF. Verifica que el archivo no est√© corrupto.');
            }
        }

        async function renderPDFPage(pageNum) {
            try {
                const page = await window.pdfDocument.getPage(pageNum);
                const canvas = document.getElementById('pdfCanvas');
                const context = canvas.getContext('2d');
                
                const viewport = page.getViewport({ scale: window.pdfZoom });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                await page.render(renderContext).promise;
                
                // Actualizar controles
                const pageInput = document.getElementById('pdfPageInput');
                const zoomLevel = document.getElementById('pdfZoomLevel');
                const prevBtn = document.getElementById('pdfPrevBtn');
                const nextBtn = document.getElementById('pdfNextBtn');
                
                if (pageInput) pageInput.value = pageNum;
                if (zoomLevel) zoomLevel.textContent = Math.round(window.pdfZoom * 100) + '%';
                if (prevBtn) prevBtn.disabled = pageNum <= 1;
                if (nextBtn) nextBtn.disabled = pageNum >= window.pdfDocument.numPages;
                
                window.pdfCurrentPage = pageNum;
                
            } catch (error) {
                console.error('Error renderizando p√°gina PDF:', error);
                showStatus('‚ùå Error al renderizar p√°gina PDF', 'error');
            }
        }

        function pdfPrevPage() {
            if (window.pdfCurrentPage > 1) {
                renderPDFPage(window.pdfCurrentPage - 1);
            }
        }

        function pdfNextPage() {
            if (window.pdfCurrentPage < window.pdfDocument.numPages) {
                renderPDFPage(window.pdfCurrentPage + 1);
            }
        }

        function pdfGoToPage() {
            const pageInput = document.getElementById('pdfPageInput');
            const pageNum = parseInt(pageInput.value);
            
            if (pageNum >= 1 && pageNum <= window.pdfDocument.numPages) {
                renderPDFPage(pageNum);
            } else {
                pageInput.value = window.pdfCurrentPage;
            }
        }

        function pdfZoomIn() {
            window.pdfZoom = Math.min(window.pdfZoom + 0.25, 3.0);
            renderPDFPage(window.pdfCurrentPage);
        }

        function pdfZoomOut() {
            window.pdfZoom = Math.max(window.pdfZoom - 0.25, 0.5);
            renderPDFPage(window.pdfCurrentPage);
        }

        function setupPDFEditor() {
            const editor = document.getElementById('docEditor');
            editor.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <h3>üìÑ PDF - Solo lectura</h3>
                    <p style="color: #666; margin: 15px 0;">Los PDFs solo se pueden visualizar. Para editar, convierte a Word.</p>
                    <div style="margin-top: 20px;">
                        <button onclick="convertPDFToWord()" class="doc-action-btn">
                            üìù Convertir a Word
                        </button>
                        <button onclick="downloadDocument()" class="doc-action-btn" style="margin-left: 10px;">
                            üì• Descargar PDF
                        </button>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 8px; font-size: 12px;">
                        <strong>üí° Funciones disponibles:</strong><br>
                        ‚Ä¢ Vista previa con navegaci√≥n<br>
                        ‚Ä¢ Zoom in/out<br>
                        ‚Ä¢ Salto a p√°gina espec√≠fica<br>
                        ‚Ä¢ Descarga del archivo original
                    </div>
                </div>
            `;
        }

        // ===== PROCESAMIENTO DE EXCEL CON SHEETJS =====
        async function loadExcelDocument(message) {
            showDocumentLoading('Cargando Excel...');
            
            try {
                // Verificar que XLSX est√© disponible
                if (typeof XLSX === 'undefined') {
                    throw new Error('SheetJS no est√° disponible');
                }
                
                // Convertir base64 a ArrayBuffer
                const response = await fetch(message.documentData);
                const arrayBuffer = await response.arrayBuffer();
                
                // Leer archivo Excel
                const workbook = XLSX.read(arrayBuffer, {
                    type: 'array',
                    cellDates: true,
                    cellFormulas: true,
                    cellStyles: true
                });
                
                // Obtener primera hoja
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Convertir a HTML table
                const htmlTable = XLSX.utils.sheet_to_html(worksheet, { editable: true });
                
                // Mostrar en vista previa
                const preview = document.getElementById('docPreview');
                preview.innerHTML = `
                    <div class="excel-container">
                        <div style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 15px;">
                            <select onchange="switchExcelSheet(this.value)" id="excelSheetSelector" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                ${workbook.SheetNames.map((name, index) => 
                                    `<option value="${index}" ${index === 0 ? 'selected' : ''}>${name}</option>`
                                ).join('')}
                            </select>
                            <span style="font-size: 12px; color: #666;">
                                üìä ${Object.keys(worksheet).filter(key => !key.startsWith('!')).length} celdas
                            </span>
                            <button onclick="refreshExcelView()" class="pdf-btn" style="margin-left: auto;">üîÑ Actualizar</button>
                        </div>
                        <div style="overflow: auto; height: calc(100% - 50px); background: white;">
                            ${htmlTable}
                        </div>
                    </div>
                `;
                
                // Guardar workbook para edici√≥n
                window.currentWorkbook = workbook;
                window.currentWorksheet = worksheet;
                window.currentSheetName = firstSheetName;
                
                // Configurar editor
                setupExcelEditor(workbook);
                
                showStatus('‚úÖ Excel cargado correctamente', 'success');
                
            } catch (error) {
                console.error('Error cargando Excel:', error);
                showDocumentError('Error al cargar Excel. Verifica que el archivo no est√© corrupto.');
            }
        }

        function switchExcelSheet(sheetIndex) {
            try {
                const workbook = window.currentWorkbook;
                const sheetName = workbook.SheetNames[sheetIndex];
                const worksheet = workbook.Sheets[sheetName];
                
                const htmlTable = XLSX.utils.sheet_to_html(worksheet, { editable: true });
                
                const container = document.querySelector('.excel-container > div:last-child');
                if (container) {
                    container.innerHTML = htmlTable;
                }
                
                window.currentWorksheet = worksheet;
                window.currentSheetName = sheetName;
                
                // Actualizar contador de celdas
                const cellCount = Object.keys(worksheet).filter(key => !key.startsWith('!')).length;
                const cellCounter = document.querySelector('.excel-container span');
                if (cellCounter) {
                    cellCounter.textContent = `üìä ${cellCount} celdas`;
                }
                
                showStatus(`üìä Cambiado a hoja: ${sheetName}`, 'success');
                
            } catch (error) {
                console.error('Error cambiando hoja:', error);
                showStatus('‚ùå Error al cambiar hoja', 'error');
            }
        }

        function refreshExcelView() {
            if (window.currentWorkbook && window.currentSheetName) {
                const sheetIndex = window.currentWorkbook.SheetNames.indexOf(window.currentSheetName);
                switchExcelSheet(sheetIndex);
                showStatus('üîÑ Vista de Excel actualizada', 'success');
            }
        }

        function setupExcelEditor(workbook) {
            const editor = document.getElementById('docEditor');
            
            // Crear tabla editable m√°s avanzada
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // Obtener rango de datos
            const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1:Z100');
            
            let tableHTML = '<div class="excel-container"><table class="excel-table"><thead><tr>';
            
            // Headers (A, B, C, etc.)
            for (let col = range.s.c; col <= Math.min(range.e.c, 25); col++) {
                const colName = XLSX.utils.encode_col(col);
                tableHTML += `<th>${colName}</th>`;
            }
            tableHTML += '</tr></thead><tbody>';
            
            // Filas de datos
            for (let row = range.s.r; row <= Math.min(range.e.r, 100); row++) {
                tableHTML += '<tr>';
                for (let col = range.s.c; col <= Math.min(range.e.c, 25); col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                    const cell = worksheet[cellAddress];
                    const value = cell ? cell.v || '' : '';
                    
                    tableHTML += `<td>
                        <input type="text" 
                               value="${value}" 
                               onchange="updateExcelCell('${cellAddress}', this.value)"
                               style="width: 100%; border: none; background: transparent; padding: 4px;">
                    </td>`;
                }
                tableHTML += '</tr>';
            }
            
            tableHTML += '</tbody></table></div>';
            
            editor.innerHTML = `
                <div style="height: 100%; display: flex; flex-direction: column;">
                    <div style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #e5e7eb;">
                        <button onclick="addExcelRow()" class="word-btn">‚ûï Fila</button>
                        <button onclick="addExcelColumn()" class="word-btn">‚ûï Columna</button>
                        <button onclick="saveExcelChanges()" class="word-btn active">üíæ Guardar cambios</button>
                    </div>
                    <div style="flex: 1; overflow: auto;">
                        ${tableHTML}
                    </div>
                </div>
            `;
            
            // Marcar como modificado
            isDocumentModified = true;
            document.getElementById('saveDocBtn').style.display = 'inline-block';
        }

        function updateExcelCell(cellAddress, value) {
            if (!window.currentWorksheet) return;
            
            // Actualizar celda en worksheet
            if (value.trim() === '') {
                delete window.currentWorksheet[cellAddress];
            } else {
                window.currentWorksheet[cellAddress] = { v: value, t: 's' };
            }
            
            isDocumentModified = true;
            updateDocumentFooter('üìù Documento modificado');
        }

        function addExcelRow() {
            showStatus('‚ûï Funci√≥n a√±adir fila en desarrollo', 'firebase');
        }

        function addExcelColumn() {
            showStatus('‚ûï Funci√≥n a√±adir columna en desarrollo', 'firebase');
        }

        function saveExcelChanges() {
            if (!window.currentWorkbook) return;
            
            try {
                // Generar nuevo archivo Excel
                const newWorkbook = XLSX.write(window.currentWorkbook, { 
                    bookType: 'xlsx', 
                    type: 'binary' 
                });
                
                showStatus('üíæ Cambios guardados en Excel', 'success');
                isDocumentModified = false;
                document.getElementById('saveDocBtn').style.display = 'none';
                updateDocumentFooter('‚úÖ Cambios guardados');
                
            } catch (error) {
                console.error('Error guardando Excel:', error);
                showStatus('‚ùå Error al guardar cambios', 'error');
            }
        }

        // ===== PROCESAMIENTO DE WORD CON MAMMOTH.JS =====
        async function loadWordDocument(message) {
            showDocumentLoading('Cargando Word...');
            
            try {
                // Convertir base64 a ArrayBuffer
                const response = await fetch(message.documentData);
                const arrayBuffer = await response.arrayBuffer();
                
                // Usar Mammoth para convertir a HTML
                const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
                const htmlContent = result.value;
                
                // Mostrar en vista previa
                const preview = document.getElementById('docPreview');
                preview.innerHTML = `
                    <div style="padding: 20px; background: white; height: 100%; overflow: auto;">
                        <div style="max-width: 800px; margin: 0 auto; font-family: 'Times New Roman', serif; line-height: 1.6;">
                            ${htmlContent}
                        </div>
                    </div>
                `;
                
                // Guardar contenido para edici√≥n
                window.originalWordContent = htmlContent;
                
                // Configurar editor
                setupWordEditor(htmlContent);
                
                if (result.messages.length > 0) {
                    console.log('Advertencias de conversi√≥n:', result.messages);
                }
                
            } catch (error) {
                console.error('Error cargando Word:', error);
                showDocumentError('Error al cargar Word. Verifica que el archivo no est√© corrupto.');
            }
        }

        function setupWordEditor(htmlContent) {
            const editor = document.getElementById('docEditor');
            
            editor.innerHTML = `
                <div class="word-editor">
                    <div class="word-toolbar">
                        <button onclick="formatText('bold')" class="word-btn" title="Negrita">
                            <strong>B</strong>
                        </button>
                        <button onclick="formatText('italic')" class="word-btn" title="Cursiva">
                            <em>I</em>
                        </button>
                        <button onclick="formatText('underline')" class="word-btn" title="Subrayado">
                            <u>U</u>
                        </button>
                        <button onclick="formatText('insertOrderedList')" class="word-btn" title="Lista numerada">
                            üìù
                        </button>
                        <button onclick="formatText('insertUnorderedList')" class="word-btn" title="Lista">
                            üìã
                        </button>
                        <button onclick="saveWordChanges()" class="word-btn active">üíæ Guardar</button>
                    </div>
                    <div id="quillEditor" class="quill-editor"></div>
                </div>
            `;
            
            // Inicializar Quill editor
            quillEditor = new Quill('#quillEditor', {
                theme: 'snow',
                placeholder: 'Edita tu documento aqu√≠...',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        ['clean']
                    ]
                }
            });
            
            // Cargar contenido
            quillEditor.root.innerHTML = htmlContent;
            
            // Detectar cambios
            quillEditor.on('text-change', function() {
                isDocumentModified = true;
                document.getElementById('saveDocBtn').style.display = 'inline-block';
                updateDocumentFooter('üìù Documento modificado');
            });
        }

        function formatText(command) {
            if (quillEditor) {
                const selection = quillEditor.getSelection();
                if (selection) {
                    switch(command) {
                        case 'bold':
                            quillEditor.format('bold', !quillEditor.getFormat().bold);
                            break;
                        case 'italic':
                            quillEditor.format('italic', !quillEditor.getFormat().italic);
                            break;
                        case 'underline':
                            quillEditor.format('underline', !quillEditor.getFormat().underline);
                            break;
                        default:
                            document.execCommand(command, false, null);
                    }
                }
            }
        }

        function saveWordChanges() {
            if (!quillEditor) return;
            
            try {
                const htmlContent = quillEditor.root.innerHTML;
                window.modifiedWordContent = htmlContent;
                
                showStatus('üíæ Cambios guardados en Word', 'success');
                isDocumentModified = false;
                document.getElementById('saveDocBtn').style.display = 'none';
                updateDocumentFooter('‚úÖ Cambios guardados');
                
            } catch (error) {
                console.error('Error guardando Word:', error);
                showStatus('‚ùå Error al guardar cambios', 'error');
            }
        }

        // ===== PROCESAMIENTO GEN√âRICO =====
        async function loadGenericDocument(message) {
            const extension = message.fileName.split('.').pop().toLowerCase();
            const iconEmoji = getDocumentIconEmoji(extension);
            
            const preview = document.getElementById('docPreview');
            preview.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 72px; margin-bottom: 20px; color: #666;">
                        ${iconEmoji}
                    </div>
                    <h3 style="color: #333; margin-bottom: 10px;">${message.fileName}</h3>
                    <p style="color: #666; margin-bottom: 5px;">Tipo: ${extension.toUpperCase()}</p>
                    <p style="color: #666; margin-bottom: 30px;">Tama√±o: ${(message.fileSize / (1024*1024)).toFixed(2)} MB</p>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: #666;">
                        <p><strong>üí° Formatos soportados para vista previa avanzada:</strong></p>
                        <p>üìÑ PDF ‚Ä¢ üìä Excel (XLS, XLSX) ‚Ä¢ üìù Word (DOC, DOCX)</p>
                        <p style="margin-top: 10px;">Este formato se puede descargar pero no tiene vista previa especializada.</p>
                    </div>
                </div>
            `;
            
            // Editor gen√©rico
            const editor = document.getElementById('docEditor');
            editor.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <h3>üìÅ ${extension.toUpperCase()} - Vista limitada</h3>
                    <p style="color: #666; margin: 15px 0;">Este tipo de archivo no tiene editor especializado.</p>
                    <div style="margin-top: 20px;">
                        <button onclick="downloadDocument()" class="doc-action-btn">
                            üì• Descargar archivo
                        </button>
                    </div>
                </div>
            `;
        }

        // ===== FUNCIONES DE NAVEGACI√ìN ENTRE TABS =====
        function switchDocTab(tabName) {
            // Actualizar tabs activos
            document.querySelectorAll('.doc-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Mostrar contenido correspondiente
            document.querySelectorAll('.doc-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'preview') {
                document.getElementById('docPreview').classList.add('active');
            } else if (tabName === 'edit') {
                document.getElementById('docEditor').classList.add('active');
                // Mostrar/ocultar bot√≥n guardar seg√∫n si hay editor
                const saveBtn = document.getElementById('saveDocBtn');
                if (currentDocumentType && ['xls', 'xlsx', 'doc', 'docx'].includes(currentDocumentType)) {
                    saveBtn.style.display = isDocumentModified ? 'inline-block' : 'none';
                } else {
                    saveBtn.style.display = 'none';
                }
            } else if (tabName === 'info') {
                document.getElementById('docInfo').classList.add('active');
            }
        }

        // ===== INFORMACI√ìN DEL DOCUMENTO =====
        function loadDocumentInfo(message) {
            const extension = message.fileName.split('.').pop().toLowerCase();
            const iconEmoji = getDocumentIconEmoji(extension);
            
            const infoContent = document.getElementById('docInfoContent');
            
            let specificInfo = '';
            if (currentDocumentType === 'pdf' && window.pdfDocument) {
                specificInfo = `
                    <p><strong>üìÑ Informaci√≥n PDF:</strong></p>
                    <p>‚Ä¢ P√°ginas: ${window.pdfDocument.numPages}</p>
                    <p>‚Ä¢ Versi√≥n PDF: ${window.pdfDocument._pdfInfo.PDFFormatVersion || 'N/A'}</p>
                `;
            } else if (['xls', 'xlsx'].includes(currentDocumentType) && window.currentWorkbook) {
                specificInfo = `
                    <p><strong>üìä Informaci√≥n Excel:</strong></p>
                    <p>‚Ä¢ Hojas: ${window.currentWorkbook.SheetNames.length}</p>
                    <p>‚Ä¢ Hojas disponibles: ${window.currentWorkbook.SheetNames.join(', ')}</p>
                `;
            } else if (['doc', 'docx'].includes(currentDocumentType)) {
                specificInfo = `
                    <p><strong>üìù Informaci√≥n Word:</strong></p>
                    <p>‚Ä¢ Formato: Microsoft Word</p>
                    <p>‚Ä¢ Editable: S√≠</p>
                `;
            }
            
            infoContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">${iconEmoji}</div>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p><strong>üìã Informaci√≥n General:</strong></p>
                    <p>‚Ä¢ Nombre: ${message.fileName}</p>
                    <p>‚Ä¢ Tama√±o: ${(message.fileSize / (1024*1024)).toFixed(2)} MB</p>
                    <p>‚Ä¢ Tipo MIME: ${message.mimeType || 'N/A'}</p>
                    <p>‚Ä¢ Enviado: ${message.timestamp}</p>
                    <p>‚Ä¢ Usuario: ${userInfo[message.sender].name}</p>
                </div>
                
                ${specificInfo ? `<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">${specificInfo}</div>` : ''}
                
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                    <p><strong>üõ†Ô∏è Capacidades:</strong></p>
                    <p>‚Ä¢ Vista previa: ${['pdf', 'xls', 'xlsx', 'doc', 'docx'].includes(currentDocumentType) ? '‚úÖ S√≠' : '‚ùå Limitada'}</p>
                    <p>‚Ä¢ Edici√≥n: ${['xls', 'xlsx', 'doc', 'docx'].includes(currentDocumentType) ? '‚úÖ S√≠' : '‚ùå No'}</p>
                    <p>‚Ä¢ Descarga: ‚úÖ S√≠</p>
                    <p>‚Ä¢ Compartir: ‚úÖ S√≠</p>
                </div>
            `;
        }

        // ===== FUNCIONES DE ACCI√ìN MEJORADAS =====
        function downloadDocument() {
            if (!currentDocument) {
                showStatus('‚ùå No hay documento seleccionado', 'error');
                return;
            }
            
            try {
                let dataToDownload = currentDocument.documentData;
                let filename = currentDocument.fileName;
                
                // Si hay modificaciones en Excel
                if (['xls', 'xlsx'].includes(currentDocumentType) && window.currentWorkbook && isDocumentModified) {
                    try {
                        const newWorkbook = XLSX.write(window.currentWorkbook, { 
                            bookType: 'xlsx', 
                            type: 'base64' 
                        });
                        dataToDownload = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,' + newWorkbook;
                        filename = filename.replace(/\.[^/.]+$/, '') + '_editado.xlsx';
                        showStatus('üìä Descargando Excel modificado...', 'success');
                    } catch (excelError) {
                        console.error('Error generando Excel:', excelError);
                        showStatus('‚ö†Ô∏è Descargando versi√≥n original (error al guardar cambios)', 'firebase');
                    }
                }
                
                // Si hay modificaciones en Word
                else if (['doc', 'docx'].includes(currentDocumentType) && window.modifiedWordContent) {
                    try {
                        // Crear HTML con estilos para descarga
                        const htmlContent = `
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <meta charset="UTF-8">
                                <title>${filename}</title>
                                <style>
                                    body { font-family: 'Times New Roman', serif; line-height: 1.6; margin: 40px; }
                                    h1, h2, h3 { color: #333; }
                                    p { margin-bottom: 10px; }
                                </style>
                            </head>
                            <body>
                                ${window.modifiedWordContent}
                            </body>
                            </html>
                        `;
                        
                        const htmlBlob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                        dataToDownload = URL.createObjectURL(htmlBlob);
                        filename = filename.replace(/\.[^/.]+$/, '') + '_editado.html';
                        showStatus('üìù Descargando Word como HTML...', 'success');
                    } catch (wordError) {
                        console.error('Error generando Word:', wordError);
                        showStatus('‚ö†Ô∏è Descargando versi√≥n original (error al guardar cambios)', 'firebase');
                    }
                }
                
                // Crear y disparar descarga
                const link = document.createElement('a');
                link.href = dataToDownload;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Limpiar URL si se cre√≥ un blob
                if (dataToDownload.startsWith('blob:')) {
                    setTimeout(() => URL.revokeObjectURL(dataToDownload), 1000);
                }
                
                showStatus(`üì• ¬°Descarga iniciada! ‚Üí ${filename}`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error en descarga:', error);
                showStatus('‚ùå Error al descargar archivo', 'error');
            }
        }

        function saveDocumentChanges() {
            if (!currentDocument) {
                showStatus('‚ùå No hay documento para guardar', 'error');
                return;
            }
            
            try {
                if (['xls', 'xlsx'].includes(currentDocumentType)) {
                    saveExcelChanges();
                } else if (['doc', 'docx'].includes(currentDocumentType)) {
                    saveWordChanges();
                } else {
                    showStatus('üíæ Este tipo de documento no es editable', 'firebase');
                }
            } catch (error) {
                console.error('Error guardando cambios:', error);
                showStatus('‚ùå Error al guardar cambios', 'error');
            }
        }

        function shareDocument() {
            if (!currentDocument) {
                showStatus('‚ùå No hay documento para compartir', 'error');
                return;
            }
            
            try {
                const shareData = {
                    title: `üìÑ ${currentDocument.fileName}`,
                    text: `Documento de Kaixo Translate: ${currentDocument.fileName} (${(currentDocument.fileSize / (1024*1024)).toFixed(1)} MB)`,
                    url: window.location.href
                };
                
                if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                    navigator.share(shareData);
                    showStatus('üîó Compartiendo documento...', 'success');
                } else {
                    // Fallback: copiar informaci√≥n al portapapeles
                    const shareText = `üìÑ ${shareData.title}\n${shareData.text}\n\nüí¨ Enviado desde: ${shareData.url}`;
                    
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(shareText);
                        showStatus('üìã Info del documento copiada al portapapeles', 'success');
                    } else {
                        // Fallback m√°s simple
                        prompt('üìã Copia esta informaci√≥n para compartir:', shareText);
                    }
                }
                
            } catch (error) {
                console.error('Error compartiendo:', error);
                showStatus('‚ùå Error al compartir documento', 'error');
            }
        }

        function convertPDFToWord() {
            showStatus('üîÑ Conversi√≥n PDF‚ÜíWord en desarrollo. Usa herramientas online mientras tanto.', 'firebase');
            // Aqu√≠ podr√≠as integrar una API de conversi√≥n como CloudConvert
        }

        function closeDocumentModal() {
            const modal = document.getElementById('documentModal');
            modal.classList.remove('active');
            
            // Limpiar variables globales
            currentDocument = null;
            currentDocumentType = null;
            documentData = null;
            isDocumentModified = false;
            
            // Limpiar editores
            if (quillEditor) {
                quillEditor = null;
            }
            
            // Limpiar PDF
            if (window.pdfDocument) {
                window.pdfDocument = null;
                window.pdfCurrentPage = 1;
                window.pdfZoom = 1.0;
            }
            
            // Limpiar Excel
            if (window.currentWorkbook) {
                window.currentWorkbook = null;
                window.currentWorksheet = null;
                window.currentSheetName = null;
            }
            
            // Ocultar bot√≥n guardar
            document.getElementById('saveDocBtn').style.display = 'none';
        }

        function updateDocumentFooter(message) {
            const footerInfo = document.getElementById('docFooterInfo');
            if (footerInfo) {
                footerInfo.textContent = message;
            }
        }

        function updateExcelInfo() {
            if (window.currentWorksheet) {
                const cellCount = Object.keys(window.currentWorksheet).filter(key => !key.startsWith('!')).length;
                updateDocumentFooter(`üìä ${cellCount} celdas en "${window.currentSheetName}"`);
            }
        }

        // ===== FUNCIONES MEJORADAS DE MENSAJES =====
        function createMessageHTML(msg) {
            const isCurrentUser = msg.sender === currentUser;
            const otherUser = currentUser === 'user1' ? 'user2' : 'user1';
            const shouldShowTranslation = !isCurrentUser && msg.translation;
            
            let messageContent = '';
            
            if (msg.type === 'image') {
                messageContent = `
                    <img src="${msg.imageData}" alt="Imagen" class="message-image" onclick="openImageViewer('${msg.imageData}')">
                    ${msg.text ? `<div class="message-text">${msg.text}</div>` : ''}
                `;
            } else if (msg.type === 'video') {
                messageContent = `
                    <div class="message-video">
                        <video id="video-${msg.id}" class="video-player" controls>
                            <source src="${msg.videoData}" type="${msg.mimeType}">
                            Tu navegador no soporta el elemento video.
                        </video>
                        ${msg.duration ? `<div class="video-duration">${msg.duration}</div>` : ''}
                    </div>
                `;
            } else if (msg.type === 'document') {
                const extension = msg.fileName.split('.').pop().toLowerCase();
                const iconClass = getDocumentIconClass(extension);
                const iconEmoji = getDocumentIconEmoji(extension);
                const isAdvancedFormat = ['pdf', 'xls', 'xlsx', 'doc', 'docx'].includes(extension);
                
                messageContent = `
                    <div class="file-message" onclick="previewDocument(${msg.id})">
                        <div class="file-icon ${iconClass}">${iconEmoji}</div>
                        <div class="file-info">
                            <div class="file-name">${msg.fileName}</div>
                            <div class="file-size">${extension.toUpperCase()} ‚Ä¢ ${(msg.fileSize / (1024*1024)).toFixed(1)} MB</div>
                            ${isAdvancedFormat ? '<div style="font-size: 10px; color: #25d366; margin-top: 2px;">‚ú® Vista previa avanzada disponible</div>' : ''}
                        </div>
                        <div class="file-actions">
                            <button onclick="event.stopPropagation(); previewDocument(${msg.id})" class="file-action-btn preview" title="Vista previa avanzada">üëÅÔ∏è</button>
                            ${isAdvancedFormat ? `<button onclick="event.stopPropagation(); openDocumentEditor(${msg.id})" class="file-action-btn edit" title="Editar documento">‚úèÔ∏è</button>` : ''}
                            <button onclick="event.stopPropagation(); downloadFile(${msg.id})" class="file-action-btn download" title="Descargar archivo">üì•</button>
                        </div>
                    </div>
                `;
            } else {
                let displayText = msg.text;
                if (shouldShowTranslation && !msg.isTranslating) {
                    displayText = msg.translation;
                } else if (msg.isTranslating) {
                    displayText = msg.text + ' (traduciendo...)';
                }
                
                // Aplicar estilo especial para emojis grandes
                if (msg.type === 'emoji') {
                    messageContent = `<div class="message-text emoji-large">${displayText}</div>`;
                } else {
                    messageContent = `<div class="message-text">${displayText}</div>`;
                }
            }
            
            // Agregar reacciones si existen
            let reactionsHTML = '';
            if (msg.reactions && Object.keys(msg.reactions).length > 0) {
                reactionsHTML = `
                    <div class="message-reactions">
                        ${Object.entries(msg.reactions).map(([emoji, count]) => 
                            `<span class="reaction" onclick="toggleReaction(${msg.id}, '${emoji}')">${emoji} ${count}</span>`
                        ).join('')}
                        <button class="reaction-btn" onclick="showReactionPicker(${msg.id})" title="A√±adir reacci√≥n">‚ûï</button>
                    </div>
                `;
            } else {
                // Solo mostrar bot√≥n de reacci√≥n en hover
                reactionsHTML = `
                    <div class="message-reactions" style="opacity: 0; transition: opacity 0.2s;" onmouseenter="this.style.opacity=1" onmouseleave="this.style.opacity=0">
                        <button class="reaction-btn" onclick="showReactionPicker(${msg.id})" title="A√±adir reacci√≥n">‚ûï</button>
                    </div>
                `;
            }
            
            return `
                <div class="message ${isCurrentUser ? 'sent' : 'received'}">
                    <div class="message-bubble ${msg.isTranslating ? 'translating' : ''} ${(msg.type === 'emoji' || msg.type === 'image' || msg.type === 'video' || msg.type === 'document') ? 'multimedia-only' : ''}">
                        ${messageContent}
                        ${shouldShowTranslation && !msg.isTranslating && msg.type === 'text' ? `
                            <div class="translation-info">
                                üìù Original (${languages[msg.senderLang].flag}): "${msg.text}"<br>
                                üåç ${languages[msg.senderLang].name} ‚Üí ${languages[userInfo[otherUser].lang].name}
                                <button onclick="playAudio('${msg.translation.replace(/'/g, "\\'")}', '${userInfo[otherUser].lang}', ${msg.id})" 
                                        class="play-btn" title="Escuchar traducci√≥n">
                                    üîä
                                </button>
                            </div>
                        ` : ''}
                        <div class="message-time">
                            ${msg.timestamp} 
                            ${msg.hasAudio ? 'üé§' : ''}
                            ${firebaseConnected ? '<span class="delivery-status">‚úì‚úì</span>' : ''}
                        </div>
                        ${reactionsHTML}
                    </div>
                </div>
            `;
        }

        function openDocumentEditor(messageId) {
            console.log('üîß Abriendo editor para mensaje:', messageId);
            previewDocument(messageId);
            // Cambiar autom√°ticamente a la pesta√±a de edici√≥n despu√©s de cargar
            setTimeout(() => {
                switchDocTab('edit');
            }, 1500);
        }

        function downloadFile(messageId) {
            const message = messages.find(m => m.id === messageId);
            if (!message) {
                showStatus('‚ùå Archivo no encontrado', 'error');
                return;
            }
            
            try {
                const link = document.createElement('a');
                link.href = message.documentData;
                link.download = message.fileName;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus(`üì• Descargando ${message.fileName}`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error descarga directa:', error);
                showStatus('‚ùå Error al descargar archivo', 'error');
            }
        }

        function openImageViewer(imageData) {
            const viewer = window.open('', '_blank');
            viewer.document.write(`
                <html>
                    <head><title>Visor de Imagen - Kaixo Translate</title></head>
                    <body style="margin:0; background:#000; display:flex; align-items:center; justify-content:center; height:100vh;">
                        <img src="${imageData}" style="max-width:100%; max-height:100%; object-fit:contain;">
                    </body>
                </html>
            `);
        }

        function scrollToBottom() {
            const container = document.getElementById('messages');
            container.scrollTop = container.scrollHeight;
        }

        // === EMOJI FUNCTIONS ===
        const emojiCategories = {
            smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•'],
            animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üêª‚Äç‚ùÑÔ∏è', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêí', 'ü¶ç', 'ü¶ß', 'üê©', 'üêï', 'üêà', 'üêÖ', 'üêÜ', 'üê¥', 'ü¶Ñ', 'ü¶ì', 'üêÇ', 'üêÉ', 'üêÑ', 'üêñ', 'üêó', 'üêè', 'üêë', 'ü¶è', 'ü¶õ', 'üêò', 'ü¶£', 'ü¶è'],
            food: ['üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'ü´ë', 'üåΩ', 'ü•ï', 'ü´í', 'üßÑ', 'üßÖ', 'ü•î', 'üç†', 'ü•ê', 'üçû', 'ü•ñ', 'ü•®', 'üßÄ', 'ü•ö', 'üç≥'],
            travel: ['‚úàÔ∏è', 'üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'üõª', 'üöö', 'üöõ', 'üöú', 'üèçÔ∏è', 'üõµ', 'üö≤', 'üõ¥', 'üõπ', 'üõº', 'üöÅ', 'üõ∏', 'üöÄ', '‚úàÔ∏è', 'üõ©Ô∏è', 'üõ´', 'üõ¨', 'ü™Ç', '‚õµ', 'üö§', 'üõ•Ô∏è', 'üõ≥Ô∏è', '‚õ¥Ô∏è', 'üö¢', '‚öì', '‚õΩ', 'üöß'],
            activities: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±', 'ü™Ä', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ç', 'üèè', 'ü™É', 'ü•Ö', '‚õ≥', 'ü™Å', 'üèπ', 'üé£', 'ü§ø', 'ü•ä', 'ü•ã', 'üéΩ', 'üõπ', 'üõ∑', '‚õ∏Ô∏è', 'ü•å', 'üéø', '‚õ∑Ô∏è', 'üèÇ', 'ü™Ç', 'üèãÔ∏è', 'ü§∏', 'ü§æ'],
            objects: ['üí°', 'üî¶', 'üïØÔ∏è', 'ü™î', 'üì±', 'üíª', 'üñ•Ô∏è', 'üñ®Ô∏è', '‚å®Ô∏è', 'üñ±Ô∏è', 'üñ≤Ô∏è', 'üíæ', 'üíø', 'üìÄ', 'üìº', 'üì∑', 'üì∏', 'üìπ', 'üé•', 'üìΩÔ∏è', 'üéûÔ∏è', 'üìû', '‚òéÔ∏è', 'üìü', 'üì†', 'üì∫', 'üìª', 'üéôÔ∏è', 'üéöÔ∏è', 'üéõÔ∏è', 'üß≠', '‚è±Ô∏è', '‚è≤Ô∏è', '‚è∞', 'üï∞Ô∏è', '‚åõ', '‚è≥', 'üì°'],
            symbols: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé']
        };

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            const gifPicker = document.getElementById('gifPicker');
            
            // Cerrar GIF picker si est√° abierto
            gifPicker.classList.remove('active');
            
            picker.classList.toggle('active');
            
            if (picker.classList.contains('active')) {
                loadEmojis('smileys');
                document.addEventListener('click', closeEmojiPicker);
            }
        }

        function closeEmojiPicker(event) {
            const picker = document.getElementById('emojiPicker');
            const emojiBtn = event.target.closest('.emoji');
            
            if (!picker.contains(event.target) && !emojiBtn) {
                picker.classList.remove('active');
                document.removeEventListener('click', closeEmojiPicker);
            }
        }

        function selectEmojiCategory(category) {
            // Actualizar categor√≠a activa
            document.querySelectorAll('.emoji-category').forEach(cat => {
                cat.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
            
            loadEmojis(category);
        }

        function loadEmojis(category) {
            const grid = document.getElementById('emojiGrid');
            const emojis = emojiCategories[category] || emojiCategories.smileys;
            
            grid.innerHTML = emojis.map(emoji => 
                `<div class="emoji-item" onclick="selectEmoji('${emoji}')">${emoji}</div>`
            ).join('');
        }

        function selectEmoji(emoji) {
            const input = document.getElementById('message-input');
            
            // Si el input est√° vac√≠o, enviar emoji como mensaje independiente
            if (input.value.trim() === '') {
                sendEmojiMessage(emoji);
                // Cerrar picker
                document.getElementById('emojiPicker').classList.remove('active');
            } else {
                // Si hay texto, a√±adir emoji al texto existente
                input.value += emoji;
                input.focus();
                // Cerrar picker
                document.getElementById('emojiPicker').classList.remove('active');
            }
        }

        function sendEmojiMessage(emoji) {
            const emojiMessage = {
                id: Date.now(),
                sender: currentUser,
                senderLang: userInfo[currentUser].lang,
                type: 'emoji',
                emoji: emoji,
                text: emoji,
                timestamp: new Date().toLocaleTimeString(),
                isTranslating: false,
                translation: null,
                hasAudio: false,
                reactions: {},
                needsTranslation: false
            };

            messages.push(emojiMessage);
            renderMessages();
            scrollToBottom();
            
            showStatus(`${emoji} Emoji enviado`, 'success');

            if (firebaseConnected) {
                setTimeout(() => {
                    showStatus('üî• Emoji sincronizado', 'firebase');
                }, 500);
            }
        }

        function searchEmojis(event) {
            const query = event.target.value.toLowerCase();
            if (query.length < 2) {
                loadEmojis('smileys');
                return;
            }
            
            // Buscar en todas las categor√≠as
            const allEmojis = Object.values(emojiCategories).flat();
            const emojiNames = {
                'üòÄ': 'happy smile face',
                'üòç': 'love heart eyes',
                'üòÇ': 'laugh cry funny',
                'üëç': 'thumbs up good',
                '‚ù§Ô∏è': 'heart love red',
                'üéâ': 'party celebration',
                'üî•': 'fire hot',
                'üíØ': 'hundred perfect',
            };
            
            const filtered = allEmojis.filter(emoji => {
                const names = emojiNames[emoji] || '';
                return names.includes(query);
            });
            
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = filtered.map(emoji => 
                `<div class="emoji-item" onclick="selectEmoji('${emoji}')">${emoji}</div>`
            ).join('');
        }

        // === GIF FUNCTIONS ===
        function toggleGifPicker() {
            const picker = document.getElementById('gifPicker');
            const emojiPicker = document.getElementById('emojiPicker');
            
            // Cerrar emoji picker si est√° abierto
            emojiPicker.classList.remove('active');
            
            picker.classList.toggle('active');
            
            if (picker.classList.contains('active')) {
                loadTrendingGifs();
                document.addEventListener('click', closeGifPicker);
            }
        }

        function closeGifPicker(event) {
            const picker = document.getElementById('gifPicker');
            const gifBtn = event.target.closest('.gif');
            
            if (!picker.contains(event.target) && !gifBtn) {
                picker.classList.remove('active');
                document.removeEventListener('click', closeGifPicker);
            }
        }

        function loadTrendingGifs() {
            const grid = document.getElementById('gifGrid');
            grid.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #666; grid-column: 1 / -1;">
                    <p>üé≠ GIFs en desarrollo</p>
                    <p style="font-size: 12px;">Pr√≥ximamente con Tenor API</p>
                </div>
            `;
        }

        function searchGifs(event) {
            const query = event.target.value.toLowerCase();
            if (query.length < 2) {
                loadTrendingGifs();
                return;
            }
            
            const grid = document.getElementById('gifGrid');
            grid.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #666; grid-column: 1 / -1;">
                    <p>üîç Buscando "${query}"...</p>
                    <p style="font-size: 12px;">Funci√≥n en desarrollo</p>
                </div>
            `;
        }

        // === STICKER FUNCTIONS ===
        function showStickers() {
            alert('üé™ Stickers en desarrollo\n\nPr√≥ximamente:\n‚Ä¢ Stickers personalizados\n‚Ä¢ Packs de stickers\n‚Ä¢ Creaci√≥n de stickers');
        }

        // === FIREBASE FUNCTIONS ===
        function toggleFirebase() {
            if (firebaseConnected) {
                disconnectFirebase();
            } else {
                document.getElementById('loginModal').style.display = 'flex';
            }
        }

        function connectFirebase() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('Por favor ingresa un nombre de usuario');
                return;
            }

            try {
                showStatus('üî• Conectando a Firebase...', 'firebase');
                
                setTimeout(() => {
                    firebaseConnected = true;
                    currentUsername = username;
                    updateFirebaseStatus();
                    closeLogin();
                    showStatus('‚úÖ Conectado a Firebase como ' + username, 'success');
                    syncMessagesWithFirebase();
                }, 1500);
                
            } catch (error) {
                console.error('Error conectando Firebase:', error);
                showStatus('‚ùå Error conectando a Firebase', 'error');
            }
        }

        function disconnectFirebase() {
            firebaseConnected = false;
            currentUsername = null;
            updateFirebaseStatus();
            showStatus('üî• Desconectado de Firebase', 'firebase');
        }

        function updateFirebaseStatus() {
            const btn = document.getElementById('firebase-btn');
            const status = document.getElementById('connectionStatus');
            
            if (firebaseConnected) {
                btn.textContent = 'üî• Firebase: ON';
                btn.classList.add('active');
                status.classList.remove('offline');
                status.title = 'Conectado a Firebase';
            } else {
                btn.textContent = 'üî• Firebase: OFF';
                btn.classList.remove('active');
                status.classList.add('offline');
                status.title = 'Modo local';
            }
        }

        function syncMessagesWithFirebase() {
            if (firebaseConnected && messages.length > 0) {
                showStatus('üîÑ Sincronizando mensajes...', 'firebase');
                setTimeout(() => {
                    showStatus('‚úÖ Mensajes sincronizados', 'success');
                }, 1000);
            }
        }

        function closeLogin() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('usernameInput').value = '';
        }

        // === REACTION FUNCTIONS ===
        function showReactionPicker(messageId) {
            const reactions = ['‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üò°', 'üëç', 'üëé'];
            
            const picker = document.createElement('div');
            picker.style.cssText = `
                position: fixed;
                background: white;
                border-radius: 25px;
                padding: 10px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                z-index: 1000;
                display: flex;
                gap: 5px;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                animation: fadeIn 0.2s ease;
            `;
            
            reactions.forEach(emoji => {
                const btn = document.createElement('button');
                btn.textContent = emoji;
                btn.style.cssText = `
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    padding: 8px;
                    border-radius: 50%;
                    transition: background 0.2s;
                `;
                btn.onmouseover = () => btn.style.background = '#f0f2f5';
                btn.onmouseout = () => btn.style.background = 'none';
                btn.onclick = () => {
                    addReaction(messageId, emoji);
                    document.body.removeChild(picker);
                };
                picker.appendChild(btn);
            });
            
            setTimeout(() => {
                document.addEventListener('click', function closeReactionPicker(e) {
                    if (!picker.contains(e.target)) {
                        if (document.body.contains(picker)) {
                            document.body.removeChild(picker);
                        }
                        document.removeEventListener('click', closeReactionPicker);
                    }
                });
            }, 100);
            
            document.body.appendChild(picker);
        }

        function addReaction(messageId, emoji) {
            const messageIndex = messages.findIndex(m => m.id === messageId);
            if (messageIndex === -1) return;
            
            if (!messages[messageIndex].reactions) {
                messages[messageIndex].reactions = {};
            }
            
            if (messages[messageIndex].reactions[emoji]) {
                messages[messageIndex].reactions[emoji]++;
            } else {
                messages[messageIndex].reactions[emoji] = 1;
            }
            
            renderMessages();
            showStatus(`Reacci√≥n ${emoji} a√±adida`, 'success');
        }

        function toggleReaction(messageId, emoji) {
            const messageIndex = messages.findIndex(m => m.id === messageId);
            if (messageIndex === -1) return;
            
            if (messages[messageIndex].reactions[emoji] > 1) {
                messages[messageIndex].reactions[emoji]--;
            } else {
                delete messages[messageIndex].reactions[emoji];
            }
            
            renderMessages();
        }

        // === USER PROFILE ===
        function showUserProfile() {
            const user = userInfo[currentUser];
            const lang = languages[user.lang];
            alert(`üë§ ${user.name}\nüåç Idioma: ${lang.name} ${lang.flag}\n${firebaseConnected ? 'üî• Conectado: ' + currentUsername : 'üì± Modo local'}`);
        }

        // === AUTO RESIZE TEXTAREA ===
        function autoResize() {
            const textarea = document.getElementById('message-input');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // === TRADUCCI√ìN UNIVERSAL MEJORADA ===
        async function translateText(text, targetLang) {
            try {
                const sourceLang = detectLanguage(text);
                
                console.log(`üîç Detectado: "${text}" como ${sourceLang} ‚Üí ${targetLang}`);
                
                if (sourceLang === targetLang) {
                    console.log('‚úÖ Mismo idioma, no traducir');
                    return text;
                }
                
                const localTranslation = await fallbackTranslation(text, sourceLang, targetLang);
                if (localTranslation && !localTranslation.includes('[') && !localTranslation.includes('flag')) {
                    console.log('‚úÖ Traducci√≥n local encontrada:', localTranslation);
                    return localTranslation;
                }
                
                const apiTranslation = await translateWithMyMemory(text, sourceLang, targetLang);
                if (apiTranslation) {
                    console.log('‚úÖ Traducci√≥n API exitosa:', apiTranslation);
                    return apiTranslation;
                }
                
                const libreTranslation = await translateWithLibre(text, sourceLang, targetLang);
                if (libreTranslation) {
                    console.log('‚úÖ Traducci√≥n LibreTranslate exitosa:', libreTranslation);
                    return libreTranslation;
                }
                
                console.log('‚ùå Todas las APIs fallaron');
                return `[${languages[targetLang].flag}] ${text}`;
                
            } catch (error) {
                console.error('‚ùå Error en traducci√≥n:', error);
                return `[Error de traducci√≥n] ${text}`;
            }
        }

        async function translateWithMyMemory(text, sourceLang, targetLang) {
            try {
                const langPair = sourceLang === 'auto' ? `autodetect|${targetLang}` : `${sourceLang}|${targetLang}`;
                const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${langPair}`;
                
                console.log('üåê MyMemory URL:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üì¶ MyMemory respuesta:', data);
                
                if (data.responseData && data.responseData.translatedText) {
                    let translation = data.responseData.translatedText;
                    
                    if (translation.includes('MYMEMORY WARNING')) {
                        translation = translation.split('MYMEMORY WARNING')[0].trim();
                    }
                    
                    if (translation.toLowerCase() === text.toLowerCase()) {
                        throw new Error('Traducci√≥n igual al original');
                    }
                    
                    return translation;
                }
                
                throw new Error('Respuesta API inv√°lida');
                
            } catch (error) {
                console.log('‚ö†Ô∏è MyMemory fall√≥:', error.message);
                return null;
            }
        }

        async function translateWithLibre(text, sourceLang, targetLang) {
            try {
                const response = await fetch('https://libretranslate.de/translate', {
                    method: 'POST',
                    body: JSON.stringify({
                        q: text,
                        source: sourceLang === 'auto' ? 'auto' : sourceLang,
                        target: targetLang,
                        format: 'text'
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üì¶ LibreTranslate respuesta:', data);
                
                if (data.translatedText && data.translatedText !== text) {
                    return data.translatedText;
                }
                
                throw new Error('Traducci√≥n LibreTranslate inv√°lida');
                
            } catch (error) {
                console.log('‚ö†Ô∏è LibreTranslate fall√≥:', error.message);
                return null;
            }
        }

        function detectLanguage(text) {
            const lowerText = text.toLowerCase().trim();
            
            console.log('üîç Detectando idioma para:', text);
            
            const patterns = {
                es: {
                    words: ['esto', 'eso', 'aqu√≠', 'ah√≠', 'sigue', 'funcionando', 'bien', 'hola', 'como', 'estas', 'que', 'gracias', 'por', 'favor', 'buenas', 'adios', 'donde', 'cuando', 'porque', 'tambi√©n'],
                    chars: /[√±√°√©√≠√≥√∫√º¬ø¬°]/
                },
                en: {
                    words: ['this', 'that', 'here', 'there', 'still', 'working', 'well', 'hello', 'how', 'are', 'you', 'thanks', 'please', 'good', 'bye', 'the', 'and', 'for', 'with'],
                    chars: null
                },
                fr: {
                    words: ['ceci', 'cela', 'ici', 'encore', 'fonctionne', 'bien', 'bonjour', 'comment', 'allez', 'vous', 'merci', 'au', 'revoir', 'bien', 'pour', 'avec'],
                    chars: /[√†√¢√ß√®√©√™√´√Æ√Ø√¥√π√ª√º√ø≈ì√¶]/
                },
                de: {
                    words: ['dies', 'das', 'hier', 'noch', 'funktioniert', 'gut', 'hallo', 'wie', 'geht', 'danke', 'bitte', 'auf', 'wiedersehen', 'gut', 'f√ºr', 'mit'],
                    chars: /[√§√∂√º√ü√Ñ√ñ√ú]/
                },
                it: {
                    words: ['questo', 'quello', 'qui', 'ancora', 'funziona', 'bene', 'ciao', 'come', 'stai', 'grazie', 'prego', 'buongiorno', 'arrivederci', 'per', 'con'],
                    chars: /[√†√®√©√¨√≠√Æ√≤√≥√π√∫]/
                },
                pt: {
                    words: ['isto', 'isso', 'aqui', 'ainda', 'funciona', 'bem', 'ol√°', 'como', 'est√°', 'obrigado', 'por', 'favor', 'bom', 'dia', 'para', 'com'],
                    chars: /[√£√µ√ß√°√©√≠√≥√∫√¢√™√¥√†]/
                },
                ru: {
                    words: ['—ç—Ç–æ', '—Ç–æ', '–∑–¥–µ—Å—å', '–≤—Å—ë', '–µ—â—ë', '—Ä–∞–±–æ—Ç–∞–µ—Ç', '—Ö–æ—Ä–æ—à–æ', '–ø—Ä–∏–≤–µ—Ç', '–∫–∞–∫', '–¥–µ–ª–∞', '—Å–ø–∞—Å–∏–±–æ', '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞', '—Ö–æ—Ä–æ—à–æ'],
                    chars: /[–∞-—è–ê-–Ø—ë–Å]/
                },
                ja: {
                    words: ['„Åì„Çå', '„Åù„Çå', '„Åì„Åì', '„Åæ„Å†', '„ÅÜ„Åæ„Åè', '„Åì„Çì„Å´„Å°„ÅØ', '„ÅÇ„Çä„Åå„Å®„ÅÜ', '„Åï„Çà„ÅÜ„Å™„Çâ'],
                    chars: /[„ÅÅ-„Çì„Ç°-„É∂„Éº‰∏Ä-Èæ†]/
                },
                ko: {
                    words: ['Ïù¥Í≤É', 'Í∑∏Í≤É', 'Ïó¨Í∏∞', 'ÏïÑÏßÅ', 'Ïûò', 'ÏïàÎÖïÌïòÏÑ∏Ïöî', 'Í∞êÏÇ¨Ìï©ÎãàÎã§'],
                    chars: /[Í∞Ä-Ìû£„Ñ±-„Öé„Öè-„Ö£]/
                },
                zh: {
                    words: ['Ëøô‰∏™', 'ÈÇ£‰∏™', 'ËøôÈáå', 'Ëøò', 'ÂæàÂ•Ω', '‰Ω†Â•Ω', 'Ë∞¢Ë∞¢', 'ÂÜçËßÅ'],
                    chars: /[\u4e00-\u9fa5]/
                },
                ar: {
                    words: ['Ÿáÿ∞ÿß', 'Ÿáÿ∞Ÿá', 'ŸáŸÜÿß', 'ŸÑÿß Ÿäÿ≤ÿßŸÑ', 'ÿ¨ŸäÿØ', 'ŸÖÿ±ÿ≠ÿ®ÿß', 'ÿ¥ŸÉÿ±ÿß'],
                    chars: /[\u0600-\u06FF]/
                },
                hi: {
                    words: ['‡§Ø‡§π', '‡§µ‡§π', '‡§Ø‡§π‡§æ‡§Å', '‡§Ö‡§≠‡•Ä ‡§≠‡•Ä', '‡§Ö‡§ö‡•ç‡§õ‡§æ', '‡§®‡§Æ‡§∏‡•ç‡§§‡•á', '‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶'],
                    chars: /[\u0900-\u097F]/
                }
            };
            
            let bestMatch = 'auto';
            let maxScore = 0;
            
            for (const [lang, pattern] of Object.entries(patterns)) {
                let score = 0;
                
                // Verificar caracteres especiales (peso alto)
                if (pattern.chars && pattern.chars.test(text)) {
                    score += 100;
                    console.log(`üî§ ${lang}: +100 por caracteres especiales`);
                }
                
                // Verificar palabras clave
                let wordMatches = 0;
                pattern.words.forEach(word => {
                    if (lowerText.includes(word)) {
                        wordMatches++;
                        score += 10;
                    }
                });
                
                if (wordMatches > 0) {
                    console.log(`üìù ${lang}: +${wordMatches * 10} por ${wordMatches} palabras`);
                }
                
                if (score > maxScore) {
                    maxScore = score;
                    bestMatch = lang;
                }
            }
            
            console.log(`üéØ Mejor coincidencia: ${bestMatch} (score: ${maxScore})`);
            return bestMatch;
        }

        async function fallbackTranslation(text, from, to) {
            const commonPhrases = {
                'hola': { en: 'hello', fr: 'bonjour', de: 'hallo', it: 'ciao', pt: 'ol√°', ru: '–ø—Ä–∏–≤–µ—Ç', ja: '„Åì„Çì„Å´„Å°„ÅØ', ko: 'ÏïàÎÖïÌïòÏÑ∏Ïöî', zh: '‰Ω†Â•Ω', ar: 'ŸÖÿ±ÿ≠ÿ®ÿß', hi: '‡§®‡§Æ‡§∏‡•ç‡§§‡•á' },
                'gracias': { en: 'thank you', fr: 'merci', de: 'danke', it: 'grazie', pt: 'obrigado', ru: '—Å–ø–∞—Å–∏–±–æ', ja: '„ÅÇ„Çä„Åå„Å®„ÅÜ', ko: 'Í∞êÏÇ¨Ìï©ÎãàÎã§', zh: 'Ë∞¢Ë∞¢', ar: 'ÿ¥ŸÉÿ±ÿß', hi: '‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶' },
                'adi√≥s': { en: 'goodbye', fr: 'au revoir', de: 'auf wiedersehen', it: 'arrivederci', pt: 'adeus', ru: '–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è', ja: '„Åï„Çà„ÅÜ„Å™„Çâ', ko: 'ÏïàÎÖïÌûà Í∞ÄÏÑ∏Ïöî', zh: 'ÂÜçËßÅ', ar: 'ŸàÿØÿßÿπÿß', hi: '‡§Ö‡§≤‡§µ‡§ø‡§¶‡§æ' },
                'hello': { es: 'hola', fr: 'bonjour', de: 'hallo', it: 'ciao', pt: 'ol√°', ru: '–ø—Ä–∏–≤–µ—Ç', ja: '„Åì„Çì„Å´„Å°„ÅØ', ko: 'ÏïàÎÖïÌïòÏÑ∏Ïöî', zh: '‰Ω†Â•Ω', ar: 'ŸÖÿ±ÿ≠ÿ®ÿß', hi: '‡§®‡§Æ‡§∏‡•ç‡§§‡•á' },
                'thank you': { es: 'gracias', fr: 'merci', de: 'danke', it: 'grazie', pt: 'obrigado', ru: '—Å–ø–∞—Å–∏–±–æ', ja: '„ÅÇ„Çä„Åå„Å®„ÅÜ', ko: 'Í∞êÏÇ¨Ìï©ÎãàÎã§', zh: 'Ë∞¢Ë∞¢', ar: 'ÿ¥ŸÉÿ±ÿß', hi: '‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶' },
                'goodbye': { es: 'adi√≥s', fr: 'au revoir', de: 'auf wiedersehen', it: 'arrivederci', pt: 'adeus', ru: '–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è', ja: '„Åï„Çà„ÅÜ„Å™„Çâ', ko: 'ÏïàÎÖïÌûà Í∞ÄÏÑ∏Ïöî', zh: 'ÂÜçËßÅ', ar: 'ŸàÿØÿßÿπÿß', hi: '‡§Ö‡§≤‡§µ‡§ø‡§¶‡§æ' },
                'yes': { es: 's√≠', fr: 'oui', de: 'ja', it: 's√¨', pt: 'sim', ru: '–¥–∞', ja: '„ÅØ„ÅÑ', ko: 'ÎÑ§', zh: 'ÊòØ', ar: 'ŸÜÿπŸÖ', hi: '‡§π‡§æ‡§Å' },
                'no': { es: 'no', fr: 'non', de: 'nein', it: 'no', pt: 'n√£o', ru: '–Ω–µ—Ç', ja: '„ÅÑ„ÅÑ„Åà', ko: 'ÏïÑÎãàÏöî', zh: '‰∏ç', ar: 'ŸÑÿß', hi: '‡§®‡§π‡•Ä‡§Ç' }
            };
            
            const lowerText = text.toLowerCase();
            
            if (commonPhrases[lowerText] && commonPhrases[lowerText][to]) {
                return commonPhrases[lowerText][to];
            }
            
            return `[${languages[to].flag}] ${text}`;
        }

        // === FUNCIONES DE CHAT ORIGINALES (MANTENER INTACTO) ===
        function switchUser() {
            currentUser = currentUser === 'user1' ? 'user2' : 'user1';
            updateUserDisplay();
            renderMessages();
            document.getElementById('message-input').focus();
        }

        function changeUserLanguage() {
            const select = document.getElementById('language-select');
            userInfo[currentUser].lang = select.value;
            updateUserDisplay();
        }

        function updateUserDisplay() {
            const user = userInfo[currentUser];
            const lang = languages[user.lang];
            document.getElementById('current-user').textContent = `üë§ ${user.name}`;
            document.getElementById('language-select').value = user.lang;
            document.getElementById('message-input').placeholder = `Escribe en ${lang.name}...`;
            
            // Actualizar avatar
            const avatar = document.getElementById('userAvatar');
            avatar.textContent = user.name.charAt(user.name.length - 1);
            avatar.style.background = currentUser === 'user1' ? 
                'linear-gradient(135deg, #667eea, #764ba2)' : 
                'linear-gradient(135deg, #f093fb, #f5576c)';
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            input.value = '';
            autoResize();
            
            // Detectar si es solo emojis (sin texto real)
            const emojiRegex = /^[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]+$/u;
            const isEmojiOnly = emojiRegex.test(text);
            
            const message = {
                id: Date.now(),
                sender: currentUser,
                senderLang: userInfo[currentUser].lang,
                type: isEmojiOnly ? 'emoji' : 'text',
                text: text,
                emoji: isEmojiOnly ? text : null,
                timestamp: new Date().toLocaleTimeString(),
                isTranslating: !isEmojiOnly,
                translation: null,
                hasAudio: !isEmojiOnly,
                reactions: {}
            };
            
            messages.push(message);
            renderMessages();
            
            // Solo traducir si es texto real (no emoji puro)
            if (!isEmojiOnly) {
                showStatus('üåê Traduciendo con IA universal...', 'firebase');
                
                const otherUser = currentUser === 'user1' ? 'user2' : 'user1';
                const targetLang = userInfo[otherUser].lang;
                
                console.log(`üîÑ Iniciando traducci√≥n: "${text}" (${userInfo[currentUser].lang} ‚Üí ${targetLang})`);
                
                try {
                    const translation = await translateText(text, targetLang);
                    
                    const messageIndex = messages.findIndex(m => m.id === message.id);
                    if (messageIndex !== -1) {
                        messages[messageIndex].translation = translation;
                        messages[messageIndex].isTranslating = false;
                    }
                    
                    console.log(`‚úÖ Traducci√≥n completada: "${translation}"`);
                    showStatus(`‚úÖ Traducido: "${text}" ‚Üí "${translation}"`, 'success');
                    
                    // Auto-reproducir si est√° habilitado y es traducci√≥n v√°lida
                    if (autoPlayEnabled && translation && translation !== text) {
                        setTimeout(() => {
                            playAudio(translation, targetLang, message.id);
                        }, 1000);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error completo:', error);
                    const messageIndex = messages.findIndex(m => m.id === message.id);
                    if (messageIndex !== -1) {
                        messages[messageIndex].translation = '[Error en traducci√≥n - Intenta de nuevo]';
                        messages[messageIndex].isTranslating = false;
                    }
                    showStatus('‚ùå Error en traducci√≥n - Revisa tu conexi√≥n', 'error');
                }
            } else {
                // Emoji puro - no traducir
                showStatus(`${text} Emoji enviado`, 'success');
            }

            // Sincronizar con Firebase si est√° conectado
            if (firebaseConnected) {
                setTimeout(() => {
                    showStatus('üî• Mensaje sincronizado', 'firebase');
                }, isEmojiOnly ? 500 : 2000);
            }
            
            renderMessages();
            scrollToBottom();
        }

        function showStatus(message, show) {
            const status = document.getElementById('status');
            status.textContent = message;
            
            if (show === true) {
                status.className = 'status active';
            } else if (show === false) {
                status.className = 'status';
                setTimeout(() => {
                    status.className = 'status';
                }, 2000);
            } else if (typeof show === 'string') {
                status.className = `status active ${show}`;
                setTimeout(() => {
                    status.className = 'status';
                }, 3000);
            }
        }

        function renderMessages() {
            const container = document.getElementById('messages');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="welcome">
                        <h3>¬°Kaixo Translate Pro v3.0! üåü</h3>
                        <p>Chat universal con IA + Vista previa y edici√≥n de PDF, Excel y Word</p>
                        <div class="language-list">
                            ${Object.entries(languages).map(([code, lang]) => 
                                `<span class="lang-badge">${lang.flag} ${lang.name}</span>`
                            ).join('')}
                        </div>
                        <div style="margin-top: 15px; font-size: 12px; color: #666;">
                            <p>üìÑ <strong>Nuevo:</strong> Vista previa de PDFs con navegaci√≥n</p>
                            <p>üìä <strong>Nuevo:</strong> Editor completo de Excel</p>
                            <p>üìù <strong>Nuevo:</strong> Editor de Word con formato</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map(msg => createMessageHTML(msg)).join('');
        }

        // === FUNCIONALIDAD DE VOZ ORIGINAL (MANTENER INTACTO) ===
        let isRecording = false;
        let recognition = null;
        let autoPlayEnabled = true;
        let voiceSpeed = 1.0;

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.maxAlternatives = 1;
                
                recognition.onstart = function() {
                    showVoiceStatus('üé§ Escuchando... Habla ahora', 'recording');
                };
                
                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    if (interimTranscript) {
                        showVoiceStatus(`üé§ "${interimTranscript}"`, 'recording');
                    }
                    
                    if (finalTranscript) {
                        document.getElementById('message-input').value = finalTranscript;
                        showVoiceStatus('üîÑ Procesando y traduciendo...', 'processing');
                        setTimeout(() => {
                            sendMessage();
                            hideVoiceStatus();
                        }, 500);
                    }
                };
                
                recognition.onerror = function(event) {
                    showVoiceStatus('‚ùå Error: ' + event.error, '');
                    setTimeout(hideVoiceStatus, 2000);
                    resetRecordingButton();
                };
                
                recognition.onend = function() {
                    resetRecordingButton();
                };
                
                return true;
            } else {
                return false;
            }
        }

        function startRecording() {
            if (isRecording) return;
            
            if (!recognition) {
                if (!initSpeechRecognition()) {
                    alert('Tu navegador no soporta reconocimiento de voz. Usa Chrome o Edge.');
                    return;
                }
            }
            
            isRecording = true;
            const userLang = userInfo[currentUser].lang;
            
            const recognitionLang = languages[userLang].voice;
            recognition.lang = recognitionLang;
            
            console.log(`üé§ Reconocimiento configurado para: ${languages[userLang].name} (${recognitionLang})`);
            
            const voiceBtn = document.getElementById('voice-btn');
            voiceBtn.classList.add('recording');
            voiceBtn.textContent = 'üî¥';
            
            showVoiceStatus(`üé§ Escuchando en ${languages[userLang].name}...`, 'recording');
            
            try {
                recognition.start();
            } catch (error) {
                resetRecordingButton();
                showVoiceStatus('‚ùå Error iniciando micr√≥fono', '');
                setTimeout(hideVoiceStatus, 2000);
            }
        }

        function stopRecording() {
            if (!isRecording) return;
            
            isRecording = false;
            if (recognition) {
                recognition.stop();
            }
            
            showVoiceStatus('üîÑ Finalizando grabaci√≥n...', 'processing');
        }

        function resetRecordingButton() {
            isRecording = false;
            const voiceBtn = document.getElementById('voice-btn');
            voiceBtn.classList.remove('recording', 'processing');
            voiceBtn.textContent = 'üé§';
        }

        function showVoiceStatus(message, type) {
            const status = document.getElementById('voice-status');
            const text = document.getElementById('voice-text');
            text.textContent = message;
            status.className = `voice-status active ${type}`;
        }

        function hideVoiceStatus() {
            const status = document.getElementById('voice-status');
            status.className = 'voice-status';
        }

        // === AUDIO REPRODUCCI√ìN ORIGINAL (MANTENER INTACTO) ===
        let availableVoices = [];

        function loadVoices() {
            return new Promise((resolve) => {
                const voices = window.speechSynthesis.getVoices();
                if (voices.length > 0) {
                    availableVoices = voices;
                    resolve(voices);
                } else {
                    window.speechSynthesis.onvoiceschanged = () => {
                        availableVoices = window.speechSynthesis.getVoices();
                        resolve(availableVoices);
                    };
                }
            });
        }

        function getBestVoiceForLanguage(langCode) {
            const langVoice = languages[langCode].voice;
            
            const voicePriorities = {
                es: ['es-ES', 'es-MX', 'es-US', 'es-AR'],
                en: ['en-US', 'en-GB', 'en-AU', 'en-CA'],
                fr: ['fr-FR', 'fr-CA', 'fr-BE'],
                de: ['de-DE', 'de-AT', 'de-CH'],
                it: ['it-IT'],
                pt: ['pt-BR', 'pt-PT'],
                ru: ['ru-RU'],
                ja: ['ja-JP'],
                ko: ['ko-KR'],
                zh: ['zh-CN', 'zh-TW', 'zh-HK'],
                ar: ['ar-SA', 'ar-AE', 'ar-EG'],
                hi: ['hi-IN']
            };
            
            const priorities = voicePriorities[langCode] || [langVoice];
            
            for (const priority of priorities) {
                const premiumVoice = availableVoices.find(voice => 
                    voice.lang === priority && 
                    (voice.name.includes('Enhanced') || 
                     voice.name.includes('Premium') || 
                     voice.name.includes('Natural') ||
                     voice.localService === false)
                );
                if (premiumVoice) return premiumVoice;
            }
            
            for (const priority of priorities) {
                const voice = availableVoices.find(v => v.lang === priority);
                if (voice) return voice;
            }
            
            const baseVoice = availableVoices.find(v => v.lang.startsWith(langCode));
            if (baseVoice) return baseVoice;
            
            return null;
        }

        function toggleAutoPlay() {
            autoPlayEnabled = !autoPlayEnabled;
            const btn = document.getElementById('autoplay-btn');
            btn.textContent = `üîä Auto-reproducir: ${autoPlayEnabled ? 'ON' : 'OFF'}`;
            btn.className = autoPlayEnabled ? 'control-btn active' : 'control-btn';
            
            showVoiceStatus(`Auto-reproducir ${autoPlayEnabled ? 'activado' : 'desactivado'}`, 'processing');
            setTimeout(hideVoiceStatus, 1500);
        }

        function changeVoiceSpeed() {
            if (voiceSpeed === 0.7) voiceSpeed = 1.0;
            else if (voiceSpeed === 1.0) voiceSpeed = 1.3;
            else voiceSpeed = 0.7;
            
            const speedName = voiceSpeed === 0.7 ? 'Lento' : voiceSpeed === 1.0 ? 'Normal' : 'R√°pido';
            const btn = document.getElementById('speed-btn');
            btn.textContent = `‚ö° Velocidad: ${speedName}`;
            
            showVoiceStatus(`Velocidad: ${speedName}`, 'processing');
            setTimeout(hideVoiceStatus, 1500);
        }

        async function playAudio(text, lang, messageId) {
            console.log('Reproduciendo:', text, 'en idioma:', lang);
            
            if ('speechSynthesis' in window) {
                if (availableVoices.length === 0) {
                    await loadVoices();
                }
                
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                
                const voice = getBestVoiceForLanguage(lang);
                if (voice) {
                    utterance.voice = voice;
                    utterance.lang = voice.lang;
                    console.log(`Usando voz: ${voice.name} (${voice.lang})`);
                } else {
                    utterance.lang = languages[lang].voice;
                    console.log(`Usando idioma por defecto: ${languages[lang].voice}`);
                }
                
                utterance.rate = voiceSpeed;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                utterance.onstart = function() {
                    const voiceName = voice ? voice.name.split(' ')[0] : languages[lang].name;
                    showVoiceStatus(`üîä ${voiceName} hablando...`, 'processing');
                };
                
                utterance.onend = function() {
                    hideVoiceStatus();
                };
                
                utterance.onerror = function(event) {
                    console.error('Error de audio:', event.error);
                    showVoiceStatus('‚ùå Error reproduciendo audio', '');
                    setTimeout(hideVoiceStatus, 2000);
                };
                
                setTimeout(() => {
                    window.speechSynthesis.speak(utterance);
                }, 100);
                
            } else {
                alert('Tu navegador no soporta s√≠ntesis de voz');
            }
        }

        function showAvailableVoices() {
            let voiceInfo = 'üéôÔ∏è VOCES DISPONIBLES:\n\n';
            
            Object.entries(languages).forEach(([code, lang]) => {
                const voice = getBestVoiceForLanguage(code);
                if (voice) {
                    voiceInfo += `${lang.flag} ${lang.name}: ${voice.name}\n`;
                } else {
                    voiceInfo += `${lang.flag} ${lang.name}: ‚ö†Ô∏è Sin voz nativa\n`;
                }
            });
            
            voiceInfo += `\nTotal: ${availableVoices.length} voces instaladas`;
            voiceInfo += `\nüî• Firebase: ${firebaseConnected ? 'Conectado' : 'Desconectado'}`;
            
            alert(voiceInfo);
        }

        // === INICIALIZACI√ìN ===
        updateUserDisplay();
        updateFirebaseStatus();
        document.getElementById('message-input').focus();
        initSpeechRecognition();

        loadVoices().then(() => {
            console.log(`‚úÖ ${availableVoices.length} voces cargadas`);
            
            Object.keys(languages).forEach(lang => {
                const voice = getBestVoiceForLanguage(lang);
                if (voice) {
                    console.log(`${languages[lang].flag} ${lang}: ${voice.name}`);
                }
            });
        });

        // === VERIFICACI√ìN DE LIBRER√çAS ===
        setTimeout(() => {
            console.log('üîç VERIFICANDO LIBRER√çAS PARA DOCUMENTOS...');
            
            // Verificar reconocimiento de voz
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                console.log('‚úÖ Reconocimiento de voz soportado');
            } else {
                console.log('‚ùå Reconocimiento de voz NO soportado');
            }
            
            // Verificar PDF.js
            if (typeof pdfjsLib !== 'undefined') {
                console.log('‚úÖ PDF.js cargado correctamente - Versi√≥n:', pdfjsLib.version);
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            } else {
                console.log('‚ùå PDF.js NO cargado - Los PDFs no funcionar√°n');
            }
            
            // Verificar SheetJS
            if (typeof XLSX !== 'undefined') {
                console.log('‚úÖ SheetJS cargado correctamente - Versi√≥n:', XLSX.version);
            } else {
                console.log('‚ùå SheetJS NO cargado - Los archivos Excel no funcionar√°n');
            }
            
            // Verificar Mammoth
            if (typeof mammoth !== 'undefined') {
                console.log('‚úÖ Mammoth.js cargado correctamente');
            } else {
                console.log('‚ùå Mammoth.js NO cargado - Los archivos Word no funcionar√°n');
            }
            
            // Verificar Quill
            if (typeof Quill !== 'undefined') {
                console.log('‚úÖ Quill.js cargado correctamente - Versi√≥n:', Quill.version);
            } else {
                console.log('‚ùå Quill.js NO cargado - La edici√≥n de Word ser√° limitada');
            }
            
            console.log('');
            console.log('üöÄüåçüé≠ Kaixo Translate Pro v3.0 - ¬°DOCUMENTOS AVANZADOS LISTOS!');
            console.log('');
            console.log('‚úÖ FUNCIONALIDADES DISPONIBLES:');
            console.log('  üìÑ Vista previa de PDFs:', typeof pdfjsLib !== 'undefined' ? '‚úÖ S√ç' : '‚ùå NO');
            console.log('  üìä Editor de Excel:', typeof XLSX !== 'undefined' ? '‚úÖ S√ç' : '‚ùå NO');
            console.log('  üìù Editor de Word:', (typeof mammoth !== 'undefined' && typeof Quill !== 'undefined') ? '‚úÖ S√ç' : '‚ùå PARCIAL');
            console.log('  üé§ Reconocimiento de voz:', ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) ? '‚úÖ S√ç' : '‚ùå NO');
            console.log('');
            console.log('üéØ C√ìMO PROBAR:');
            console.log('  1. üìÑ Env√≠a un PDF ‚Üí Haz clic en üëÅÔ∏è para vista previa con navegaci√≥n');
            console.log('  2. üìä Env√≠a un Excel ‚Üí Haz clic en ‚úèÔ∏è para editar celdas');
            console.log('  3. üìù Env√≠a un Word ‚Üí Haz clic en ‚úèÔ∏è para editor completo');
            console.log('  4. üì• Usa el bot√≥n descarga en cualquier momento');
            console.log('');
            console.log('‚ö†Ô∏è Si algo no funciona, revisa la consola para mensajes de error.');
            
        }, 2000);

        // === FUNCI√ìN DE DEBUG PARA USUARIOS ===
        window.debugKaixo = function() {
            console.log('üîß INFORMACI√ìN DE DEBUG KAIXO TRANSLATE:');
            console.log('');
            console.log('üìä Estado del chat:');
            console.log('  ‚Ä¢ Mensajes totales:', messages.length);
            console.log('  ‚Ä¢ Usuario actual:', currentUser);
            console.log('  ‚Ä¢ Firebase conectado:', firebaseConnected);
            console.log('  ‚Ä¢ Documento actual:', currentDocument ? currentDocument.fileName : 'Ninguno');
            console.log('');
            console.log('üìö Librer√≠as:');
            console.log('  ‚Ä¢ PDF.js:', typeof pdfjsLib !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  ‚Ä¢ SheetJS:', typeof XLSX !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  ‚Ä¢ Mammoth:', typeof mammoth !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('  ‚Ä¢ Quill:', typeof Quill !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('');
            console.log('üé§ Audio:');
            console.log('  ‚Ä¢ Voces disponibles:', availableVoices.length);
            console.log('  ‚Ä¢ Auto-reproducir:', autoPlayEnabled);
            console.log('  ‚Ä¢ Velocidad:', voiceSpeed);
            console.log('');
            console.log('üí° Para reportar problemas, comparte esta informaci√≥n.');
        };

        console.log('');
        console.log('üí° TIP: Escribe debugKaixo() en la consola para ver informaci√≥n de debug.');
        console.log('üì± ¬°Todo listo para usar! Env√≠a documentos y prueba las nuevas funciones.');

    </script>
</body>
</html>